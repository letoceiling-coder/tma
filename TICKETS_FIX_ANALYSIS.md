# Анализ проблем с начислением билетов и предложения по исправлению

## Текущее состояние системы

### Существующая логика

1. **Восстановление билетов (ticket_restore_hours)**
   - Работает через `tickets_depleted_at` + интервал (по умолчанию 3 часа)
   - Восстанавливает 1 билет каждые N часов, когда билеты = 0
   - Логика в `TicketController::checkTicketRestore()`

2. **Стартовые билеты для новых пользователей**
   - Начисляются при первом входе через `initial_tickets_count` из настроек
   - Работает в `WowAuthController::init()`, `WheelController::spin()`, `TicketController::getTickets()`

3. **Реферальные билеты**
   - Начисляются рефереру при регистрации нового пользователя
   - Логика в `TelegramWebhookController` (строка 377)

---

## Выявленные проблемы

### Проблема 1: Отсутствует ежедневное начисление билетов

**Текущее состояние:**
- Нет поля `last_ticket_received_at` в таблице `users`
- Нет поля `daily_tickets` в таблице `wheel_settings`
- Нет логики ежедневного начисления

**Ожидаемое поведение:**
- Билеты должны начисляться каждый день (раз в 24 часа)
- Независимо от текущего баланса билетов
- Настраиваемое количество через `daily_tickets` в админке

**Где нужно исправить:**
1. Добавить миграцию для полей:
   - `last_ticket_received_at` (datetime, nullable) в `users`
   - `daily_tickets` (integer, default: 1) в `wheel_settings`
   - `default_daily_tickets` (integer, default: 1) в `wheel_settings` (для новых пользователей)

2. Добавить логику проверки и начисления в:
   - `TicketController::getTickets()` - при каждом запросе билетов
   - `WowAuthController::init()` - при инициализации пользователя
   - `WheelController::spin()` - перед спином (опционально)

3. Добавить метод в `User` модель:
   - `checkAndAwardDailyTickets()` - проверяет, прошло ли 24 часа, и начисляет билеты

---

### Проблема 2: Реферальные билеты сбрасывают таймер восстановления

**Текущее состояние:**
В `TelegramWebhookController` (строка 379-382):
```php
// Если билеты стали больше 0, сбрасываем точку восстановления
if ($referrer->tickets_available > 0) {
    $referrer->tickets_depleted_at = null;
}
```

**Проблема:**
- Если у пользователя было 0 билетов и работал таймер восстановления
- Он пригласил кого-то и получил 1 билет
- `tickets_depleted_at` сбрасывается в `null`
- Если он потратит этот билет, таймер начнется заново с нуля
- Это правильно, НО если у него уже был активный таймер, он теряется

**Ожидаемое поведение:**
- Реферальные билеты не должны влиять на таймер восстановления
- Таймер должен продолжать работать независимо от источника билетов
- Или таймер должен сбрасываться только если билеты были восстановлены через таймер

**Где нужно исправить:**
- `TelegramWebhookController` - не сбрасывать `tickets_depleted_at` при начислении реферальных билетов
- Или сбрасывать только если билеты были восстановлены через таймер (нужно добавить флаг)

---

### Проблема 3: Таймер обрывается при реферальных билетах

**Текущее состояние:**
В `TicketController::getTickets()` (строка 93-115):
- Если билеты = 0 и `tickets_depleted_at` не установлен, устанавливается
- Но если пользователь получил реферальный билет, `tickets_depleted_at` сбрасывается
- При следующем обнулении таймер начинается заново

**Проблема:**
- Если пользователь пригласил кого-то, когда у него было 0 билетов
- Он получил билет, таймер сбросился
- Если он потратит билет, таймер начнется заново
- Но если он не тратил билет, а просто зашел через 2 дня, таймер не работает

**Ожидаемое поведение:**
- Таймер должен работать независимо от наличия билетов на момент приглашения
- Ежедневные билеты должны начисляться независимо от таймера восстановления
- Два механизма не должны конфликтовать

---

### Проблема 4: Нет начисления билетов после простоя

**Текущее состояние:**
- Если пользователь не заходил 2 дня, билеты не начисляются
- Ежедневное начисление не реализовано
- Восстановление работает только если билеты = 0 и установлен `tickets_depleted_at`

**Ожидаемое поведение:**
- При входе пользователя проверять, прошло ли 24 часа с `last_ticket_received_at`
- Если прошло, начислить `daily_tickets` билетов
- Обновить `last_ticket_received_at`

---

## Предложения по исправлению

### Решение 1: Добавить ежедневное начисление билетов

**Миграция:**
```php
// Добавить поля в users
Schema::table('users', function (Blueprint $table) {
    $table->timestamp('last_ticket_received_at')->nullable()->after('tickets_depleted_at');
});

// Добавить поля в wheel_settings
Schema::table('wheel_settings', function (Blueprint $table) {
    $table->integer('daily_tickets')->default(1)->after('initial_tickets_count');
    $table->integer('default_daily_tickets')->default(1)->after('daily_tickets');
});
```

**Логика начисления:**
1. При каждом запросе билетов (`getTickets()`, `init()`, `spin()`) проверять:
   - Если `last_ticket_received_at === null` → начислить `default_daily_tickets` и установить `last_ticket_received_at = now()`
   - Если `last_ticket_received_at !== null` и прошло >= 24 часов → начислить `daily_tickets` и обновить `last_ticket_received_at = now()`

2. Начисление должно происходить независимо от текущего баланса билетов

3. Создать метод в `User` модели:
```php
public function checkAndAwardDailyTickets(): bool
{
    $settings = WheelSetting::getSettings();
    $dailyTickets = $settings->daily_tickets ?? 1;
    $defaultTickets = $settings->default_daily_tickets ?? 1;
    
    // Если это первый раз (last_ticket_received_at === null)
    if (!$this->last_ticket_received_at) {
        $ticketsToAdd = $defaultTickets;
        $this->last_ticket_received_at = now();
        $this->tickets_available += $ticketsToAdd;
        $this->save();
        
        // Создать запись в user_tickets
        UserTicket::create([
            'user_id' => $this->id,
            'tickets_count' => $ticketsToAdd,
            'restored_at' => null,
            'source' => 'daily_bonus',
        ]);
        
        return true;
    }
    
    // Проверяем, прошло ли 24 часа
    $hoursSinceLastTicket = now()->diffInHours($this->last_ticket_received_at);
    
    if ($hoursSinceLastTicket >= 24) {
        $this->last_ticket_received_at = now();
        $this->tickets_available += $dailyTickets;
        $this->save();
        
        // Создать запись в user_tickets
        UserTicket::create([
            'user_id' => $this->id,
            'tickets_count' => $dailyTickets,
            'restored_at' => null,
            'source' => 'daily_bonus',
        ]);
        
        return true;
    }
    
    return false;
}
```

---

### Решение 2: Исправить логику реферальных билетов

**Проблема:** Реферальные билеты сбрасывают `tickets_depleted_at`, что ломает таймер

**Исправление:**
В `TelegramWebhookController` (строка 377-382):
```php
// Начисляем 1 билет рефереру за приглашение
$referrer->tickets_available = $referrer->tickets_available + 1;

// НЕ сбрасываем tickets_depleted_at при реферальных билетах
// Таймер восстановления должен работать независимо
// Сбрасываем только если билеты были восстановлены через таймер
// (это уже обрабатывается в checkTicketRestore)

// Удалить эти строки:
// if ($referrer->tickets_available > 0) {
//     $referrer->tickets_depleted_at = null;
// }
```

**Альтернативное решение:**
- Сбрасывать `tickets_depleted_at` только если билеты были восстановлены через таймер
- Добавить флаг `tickets_restored_via_timer` для отслеживания
- Или не сбрасывать вообще, пусть таймер продолжает работать

---

### Решение 3: Разделить логику восстановления и ежедневного начисления

**Текущая проблема:** Два механизма конфликтуют

**Предложение:**
1. **Восстановление билетов (ticket_restore_hours)** - работает только когда билеты = 0
2. **Ежедневное начисление (daily_tickets)** - работает независимо, каждые 24 часа

**Логика:**
- Ежедневное начисление проверяется первым
- Если прошло 24 часа → начислить `daily_tickets`
- Затем проверяется восстановление (если билеты = 0)

**Порядок проверки в `getTickets()`:**
1. Проверить и начислить ежедневные билеты (`checkAndAwardDailyTickets()`)
2. Проверить и восстановить билеты через таймер (`checkTicketRestore()`)
3. Вернуть актуальное количество билетов

---

### Решение 4: Исправить таймер на фронтенде

**Проблема:** Таймер обрывается, если пользователь получил билеты из другого источника

**Исправление:**
В `MainWheel.tsx`:
- Таймер должен показываться только если `tickets_available === 0` И `tickets_depleted_at !== null`
- Если пользователь получил билеты (реферальные, ежедневные), таймер должен скрываться
- При следующем обнулении таймер должен начинаться заново

**Логика:**
```typescript
// Таймер показывается только если:
const shouldShowTimer = tickets === 0 && nextTicketAt !== null;

// Если билеты появились (стали > 0), таймер скрывается
// При следующем обнулении таймер начинается заново
```

---

## План реализации

### Этап 1: Миграции и модели

1. Создать миграцию для добавления полей:
   - `last_ticket_received_at` в `users`
   - `daily_tickets` в `wheel_settings`
   - `default_daily_tickets` в `wheel_settings`

2. Обновить модель `User`:
   - Добавить метод `checkAndAwardDailyTickets()`
   - Добавить cast для `last_ticket_received_at`

3. Обновить модель `WheelSetting`:
   - Добавить поля в `$fillable`
   - Добавить валидацию значений

### Этап 2: Логика начисления

1. Добавить проверку ежедневных билетов в:
   - `TicketController::getTickets()`
   - `WowAuthController::init()`
   - `WheelController::spin()` (опционально)

2. Исправить логику реферальных билетов:
   - Убрать сброс `tickets_depleted_at` при начислении реферальных билетов
   - Или добавить условие для сброса только при восстановлении через таймер

3. Обновить `checkTicketRestore()`:
   - Убедиться, что не конфликтует с ежедневным начислением
   - Проверять ежедневные билеты перед восстановлением

### Этап 3: Админ-панель

1. Добавить поля в настройки рулетки:
   - `daily_tickets` - количество билетов ежедневно
   - `default_daily_tickets` - количество билетов для новых пользователей

2. Добавить валидацию:
   - Минимум 0, максимум 100
   - По умолчанию 1

### Этап 4: Тестирование

1. Тест 1: Новый пользователь
   - Создать нового пользователя
   - Проверить, что начислено `default_daily_tickets` билетов
   - Проверить, что `last_ticket_received_at` установлен

2. Тест 2: Ежедневное начисление
   - Пользователь с билетами на балансе
   - Прошло 24+ часов
   - Проверить, что начислено `daily_tickets` билетов

3. Тест 3: Пользователь не заходил 2 дня
   - Пользователь не заходил 48 часов
   - При входе должно начислиться `daily_tickets` билетов (не 2x, а 1x - только за последние 24 часа)

4. Тест 4: Реферальные билеты
   - Пользователь с 0 билетов и активным таймером
   - Пригласил кого-то, получил билет
   - Проверить, что таймер не сбросился (или сбросился правильно)
   - Потратил билет, проверить что таймер работает

5. Тест 5: Комбинация сценариев
   - Пользователь не крутил 24+ часов
   - У него были билеты
   - У него не было билетов
   - Он пригласил кого-то в этот момент

---

## Важные замечания

1. **Ежедневное начисление vs Восстановление:**
   - Ежедневное начисление - каждый день независимо от баланса
   - Восстановление - каждые N часов, только если билеты = 0
   - Два механизма не должны конфликтовать

2. **Порядок проверки:**
   - Сначала ежедневное начисление (если прошло 24 часа)
   - Затем восстановление (если билеты = 0)

3. **Реферальные билеты:**
   - Не должны влиять на таймер восстановления
   - Не должны влиять на ежедневное начисление
   - Должны просто добавляться к балансу

4. **Логирование:**
   - Логировать все начисления билетов
   - Указывать источник: `daily_bonus`, `referral_bonus`, `ticket_restore`, `initial_bonus`

5. **Производительность:**
   - Проверка ежедневных билетов должна быть быстрой
   - Использовать индексы на `last_ticket_received_at`
   - Кэшировать настройки `WheelSetting`

---

## Дополнительные улучшения

1. **Настройка включения/отключения Stars в админке:**
   - Добавить поле `stars_enabled` (boolean) в `wheel_settings`
   - Проверять это поле перед показом функционала Stars на фронтенде

2. **История начислений:**
   - Уже есть таблица `user_tickets` для отслеживания
   - Убедиться, что все источники логируются правильно

3. **Уведомления:**
   - Уведомлять пользователя о ежедневном начислении билетов
   - Уведомлять о реферальных билетах (уже реализовано)

4. **Статистика:**
   - Отслеживать, сколько билетов начислено через каждый источник
   - Показывать в админ-панели

---

## Приоритет исправлений

**Высокий приоритет:**
1. Добавить ежедневное начисление билетов
2. Исправить логику реферальных билетов (не сбрасывать таймер)
3. Исправить начисление после простоя

**Средний приоритет:**
4. Добавить настройки в админ-панель
5. Улучшить логирование

**Низкий приоритет:**
6. Добавить настройку включения/отключения Stars
7. Улучшить статистику



