# Настройка системы проверки подписки

## Описание

Система проверки подписки интегрирована в админ-панель и автоматически проверяет статус подписки при каждом обращении к админ-панели.

## Настройка

### 1. Переменные окружения

Добавьте в файл `.env` следующие переменные:

```env
# Subscription API Configuration
SUBSCRIPTION_API_URL=https://crm.siteaccess.ru/api/v1/subscription/check
SUBSCRIPTION_API_TOKEN=your_subscription_api_token_here
SUBSCRIPTION_CACHE_TTL=120
SUBSCRIPTION_WARNING_DAYS=3
```

### 2. Получение API токена

1. Перейдите на https://crm.siteaccess.ru/admin/subscriptions
2. Войдите в систему с правами администратора
3. Найдите или создайте подписку для вашего сайта
4. Нажмите на кнопку "API токен" (иконка ключа)
5. Скопируйте токен и сохраните его в `.env` файле

**Важно:** При обновлении токена старый токен перестанет работать. Обновите конфигурацию на вашем сайте.

## Функциональность

### Автоматическая проверка

- Проверка подписки выполняется при каждом обращении к админ-панели через middleware
- Результат кэшируется на 2 минуты (настраивается через `SUBSCRIPTION_CACHE_TTL`)
- При истечении подписки пользователь автоматически перенаправляется на страницу-заглушку

### Уведомления

- За 3 дня до истечения подписки отображается предупреждение в админ-панели
- Компонент `SubscriptionInfo` показывает статус подписки на главной странице админ-панели

### Блокировка доступа

- При истечении подписки (`status: "expired"` или `is_active: false`) весь функционал админ-панели блокируется
- Отображается страница-заглушка с информацией о необходимости продления подписки

## API Endpoint

### Проверка подписки

**URL:** `GET /api/subscription/check`

**Требуется авторизация:** Да (Bearer Token)

**Ответ:**
```json
{
  "success": true,
  "subscription": {
    "status": "active",
    "expires_at": "2025-01-15 23:59:59",
    "is_active": true
  },
  "is_active": true,
  "is_expiring_soon": false,
  "days_until_expiry": 45
}
```

## Структура файлов

- `app/Services/SubscriptionService.php` - Сервис для работы с API подписки
- `app/Http/Middleware/CheckSubscription.php` - Middleware для проверки подписки
- `app/Http/Controllers/SubscriptionExpiredController.php` - Контроллер страницы-заглушки
- `app/Http/Controllers/Api/SubscriptionCheckController.php` - API контроллер для проверки подписки
- `resources/views/subscription/expired.blade.php` - Шаблон страницы-заглушки
- `resources/js/components/admin/SubscriptionInfo.vue` - Vue компонент для отображения информации о подписке
- `config/subscription.php` - Конфигурация подписки

## Тестирование

1. Убедитесь, что API токен правильно настроен
2. Проверьте работу страницы-заглушки: `/subscription-expired`
3. Проверьте отображение информации о подписке в админ-панели
4. Проверьте работу уведомлений за 3 дня до истечения

## Обработка ошибок

- **401 Unauthorized:** API токен неверный → проверьте токен в `.env`
- **404 Not Found:** Подписка не найдена → создайте подписку в CRM системе
- **429 Too Many Requests:** Превышен лимит → используется кэш, повторите позже
- **Network Error:** Проблемы с сетью → используется последний известный статус из кэша

## Кэширование

Результат проверки подписки кэшируется на 2 минуты по умолчанию. Это позволяет:
- Уменьшить нагрузку на API
- Улучшить производительность админ-панели
- Сохранить работоспособность при временных проблемах с сетью

Для очистки кэша используйте:
```php
app(\App\Services\SubscriptionService::class)->clearCache();
```

