# Инструкция по деплою проекта

## Описание

Команда `php artisan deploy` автоматизирует процесс деплоя:
1. Собирает фронтенд приложения (Vue админка и React)
2. Добавляет изменения в git
3. Создает коммит
4. Отправляет в репозиторий GitHub (https://github.com/letoceiling-coder/tma.git)
5. Отправляет POST запрос на сервер для обновления проекта

## Настройка

### 1. Настройка Git репозитория

Репозиторий уже настроен: `https://github.com/letoceiling-coder/tma.git`

Команда автоматически:
- Проверяет наличие remote origin
- Добавляет или обновляет его при необходимости

### 2. Настройка переменных окружения на ЛОКАЛЬНОЙ машине

Добавьте в файл `.env` на локальной машине:

```env
DEPLOY_SERVER_URL=https://ваш-сервер.com
DEPLOY_TOKEN=ваш-секретный-токен
```

Где:
- `DEPLOY_SERVER_URL` - URL вашего сервера (без `/api/deploy` в конце)
- `DEPLOY_TOKEN` - секретный токен для авторизации (должен быть одинаковым на локальной машине и сервере)

### 3. Настройка переменных окружения на СЕРВЕРЕ

На сервере добавьте в файл `.env`:

```env
DEPLOY_TOKEN=ваш-секретный-токен
PHP_PATH=/usr/bin/php  # Опционально, если PHP не в PATH
COMPOSER_PATH=/usr/local/bin/composer  # Опционально, если composer не в PATH
```

**ВАЖНО:** Токен `DEPLOY_TOKEN` должен быть одинаковым на локальной машине и на сервере!

### 4. Endpoint на сервере

✅ **Endpoint `/api/deploy` уже реализован в проекте!**

Он находится в:
- Контроллер: `app/Http/Controllers/Api/DeployController.php`
- Middleware: `app/Http/Middleware/VerifyDeployToken.php`
- Маршрут: `routes/api.php` (строка 58)

Что делает endpoint:
- Принимает POST запрос с заголовком `X-Deploy-Token`
- Проверяет токен через middleware
- Выполняет `git pull` из репозитория
- Выполняет `composer install`
- Запускает миграции
- Опционально запускает seeders (если `run_seeders=true`)
- Очищает кеши
- Оптимизирует приложение
- Возвращает результат в формате JSON

Пример ответа сервера:
```json
{
  "data": {
    "php_path": "/usr/bin/php",
    "php_version": "8.2.0",
    "git_pull": "успешно",
    "composer_install": "успешно",
    "migrations": {
      "status": "success",
      "message": "Все миграции применены"
    },
    "seeders": {
      "status": "skipped",
      "message": "Seeders пропущены"
    },
    "duration_seconds": 5.2,
    "deployed_at": "2025-01-20 12:00:00"
  }
}
```

## Использование

### Базовое использование

```bash
php artisan deploy
```

### Опции команды

#### Кастомное сообщение коммита

```bash
php artisan deploy --message="Обновление функционала"
```

#### Пропустить сборку

Если фронтенд уже собран:

```bash
php artisan deploy --skip-build
```

#### Пробный запуск (dry-run)

Посмотреть, что будет сделано, без выполнения:

```bash
php artisan deploy --dry-run
```

#### Отключить проверку SSL

Для локальной разработки или самоподписанных сертификатов:

```bash
php artisan deploy --insecure
```

#### Запустить seeders на сервере

По умолчанию seeders пропускаются. Для их запуска:

```bash
php artisan deploy --with-seed
```

### Комбинирование опций

```bash
php artisan deploy --message="Важное обновление" --with-seed --insecure
```

## Процесс деплоя

1. **Сборка фронтенда** (`npm run build:all`)
   - Собирает Vue админку → `public/build/`
   - Собирает React приложение → `public/frontend/`

2. **Проверка git статуса**
   - Проверяет наличие изменений
   - Предупреждает о больших файлах (>10MB)

3. **Проверка git remote**
   - Убеждается, что origin настроен на правильный репозиторий

4. **Добавление в git**
   - Выполняет `git add .`
   - Убеждается, что собранные файлы добавлены

5. **Создание коммита**
   - Создает коммит с указанным сообщением
   - По умолчанию: `Deploy: YYYY-MM-DD HH:MM:SS`

6. **Отправка в репозиторий**
   - Выполняет `git push origin <branch>`
   - Автоматически устанавливает upstream при необходимости

7. **Запрос на сервер**
   - Отправляет POST запрос на `/api/deploy`
   - Передает commit hash, branch, timestamp
   - Сервер обновляет проект из git

## Обработка ошибок

- **Большие файлы**: Команда предупредит о файлах >10MB и спросит подтверждение
- **Таймауты**: Для git push установлен таймаут 5 минут
- **Отсутствие изменений**: Запросит подтверждение на продолжение
- **Ошибки сборки**: Прервет выполнение с описанием ошибки

## Примеры использования

### Ежедневный деплой

```bash
php artisan deploy
```

### Деплой с описанием изменений

```bash
php artisan deploy --message="Добавлена новая функция оплаты"
```

### Деплой без сборки (если уже собрано)

```bash
php artisan deploy --skip-build --message="Обновление конфигурации"
```

### Проверка перед деплоем

```bash
php artisan deploy --dry-run
```

## Примечания

- Команда требует настроенный git репозиторий
- Требуется доступ к GitHub репозиторию
- Для работы с сервером нужны `DEPLOY_SERVER_URL` и `DEPLOY_TOKEN`
- Команда не удаляет файлы, только добавляет и обновляет

