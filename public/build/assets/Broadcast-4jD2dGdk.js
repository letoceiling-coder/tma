import{_ as E,r as o,k as N,c as l,a as e,b as i,t as a,d as g,D as F,v as T,e as M,C as q,F as H,q as L,p as D,j as C,o as d}from"./admin-BJZEhXMZ.js";const R={class:"broadcast-page space-y-6"},$={key:0,class:"flex items-center justify-center py-12"},A={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},G={class:"text-destructive"},J={key:2,class:"p-4 bg-green-500/10 border border-green-500/20 rounded-lg"},K={class:"text-green-600"},O={key:3,class:"space-y-6"},P={class:"bg-card rounded-lg border border-border p-6"},Q={class:"flex items-center justify-between"},W={class:"relative inline-flex items-center cursor-pointer"},X={class:"bg-card rounded-lg border border-border p-6 space-y-4"},Y={class:"text-xs text-muted-foreground mt-1"},Z={class:"bg-muted px-1 rounded"},ee={class:"bg-muted px-1 rounded"},se={class:"bg-card rounded-lg border border-border p-6"},te={class:"flex items-center justify-between"},re={class:"flex items-center gap-3"},ae={class:"bg-card rounded-lg border border-border p-6"},oe={class:"flex items-center justify-between"},le={class:"flex items-center gap-3"},de={class:"flex justify-end"},ne=["disabled"],ue={class:"bg-card rounded-lg border border-border p-6 space-y-4"},ie={class:"mb-4"},ce={key:0,class:"mb-4 max-h-64 overflow-y-auto border border-border rounded-lg"},be=["onClick"],ve={class:"flex items-center justify-between"},ge={class:"text-sm font-medium"},me={class:"text-xs text-muted-foreground"},fe={key:0,class:"text-accent"},pe={key:1,class:"mb-4 text-sm text-muted-foreground text-center py-4"},xe={key:2,class:"mb-4 text-sm text-muted-foreground text-center py-4"},_e={key:3,class:"mb-4 p-3 bg-muted/30 rounded-lg"},ye={class:"text-sm text-muted-foreground"},he={class:"mb-4"},we=["disabled"],ke={key:0,class:"text-sm text-muted-foreground"},Te={key:1,class:"text-sm text-muted-foreground mt-2"},Ce={class:"mt-1 p-2 bg-background rounded border border-border"},je={__name:"Broadcast",setup(Ue){const h=o(!0),w=o(!1),c=o(null),v=o(null),m=o(!1),f=o(""),p=o(24),x=o("after_registration"),b=o(""),_=o([]),j=o(!1),u=o(null),U=o(""),k=o(!1),n=o(null);let V=null;const I=async()=>{h.value=!0,c.value=null,v.value=null;try{const t=await C.get("/api/v1/wow/wheel/settings");if(t.data.settings){const s=t.data.settings;m.value=s.broadcast_enabled??!1,f.value=s.broadcast_message_text??"",p.value=s.broadcast_interval_hours??24,x.value=s.broadcast_trigger??"after_registration"}}catch(t){c.value=t.response?.data?.message||"Ошибка загрузки настроек"}finally{h.value=!1}},y=async()=>{w.value=!0,c.value=null,v.value=null;try{const t=await C.put("/api/v1/wow/wheel/settings",{broadcast_enabled:m.value,broadcast_message_text:f.value,broadcast_interval_hours:p.value,broadcast_trigger:x.value});if(t.data.success){if(v.value="Настройки успешно сохранены",t.data.settings){const s=t.data.settings;m.value=s.broadcast_enabled??!1,f.value=s.broadcast_message_text??"",p.value=s.broadcast_interval_hours??24,x.value=s.broadcast_trigger??"after_registration"}setTimeout(()=>{v.value=null},3e3)}}catch(t){c.value=t.response?.data?.message||"Ошибка сохранения настроек"}finally{w.value=!1}},B=async()=>{if(V&&clearTimeout(V),!b.value||b.value.length<2){_.value=[];return}V=setTimeout(async()=>{j.value=!0;try{const t=await C.get("/api/v1/wow/users",{params:{search:b.value,per_page:20}});_.value=t.data.data||[]}catch(t){console.error("Error searching users:",t),_.value=[]}finally{j.value=!1}},500)},S=t=>{u.value=t,n.value=null},z=async()=>{if(u.value){k.value=!0,n.value=null,c.value=null;try{const t=await C.post("/api/v1/wow/wheel/test-broadcast",{user_id:u.value.id,message:U.value||null});t.data.success?n.value={success:!0,message:t.data.message,sent_message:t.data.sent_message}:n.value={success:!1,message:t.data.message||"Ошибка отправки",error_code:t.data.error_code,error_description:t.data.error_description}}catch(t){n.value={success:!1,message:t.response?.data?.message||"Ошибка отправки сообщения"}}finally{k.value=!1}}};return N(()=>{I()}),(t,s)=>(d(),l("div",R,[s[25]||(s[25]=e("div",{class:"flex items-center justify-between"},[e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Рассылки"),e("p",{class:"text-muted-foreground mt-1"},"Управление автоматическими рассылками от Telegram-бота")])],-1)),h.value?(d(),l("div",$,[...s[6]||(s[6]=[e("div",{class:"text-muted-foreground"},"Загрузка...",-1)])])):i("",!0),c.value?(d(),l("div",A,[e("p",G,a(c.value),1)])):i("",!0),v.value?(d(),l("div",J,[e("p",K,a(v.value),1)])):i("",!0),h.value?i("",!0):(d(),l("div",O,[e("div",P,[e("div",Q,[s[8]||(s[8]=e("div",null,[e("h3",{class:"text-base font-medium mb-1"},"Включить рассылки"),e("p",{class:"text-sm text-muted-foreground"}," Включает или выключает систему автоматических рассылок ")],-1)),e("label",W,[g(e("input",{"onUpdate:modelValue":s[0]||(s[0]=r=>m.value=r),onChange:y,type:"checkbox",class:"sr-only peer"},null,544),[[F,m.value]]),s[7]||(s[7]=e("div",{class:"w-11 h-6 bg-muted peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-border after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"},null,-1))])])]),e("div",X,[e("div",null,[s[13]||(s[13]=e("label",{class:"text-sm font-medium mb-2 block"},"Текст рассылки",-1)),g(e("textarea",{"onUpdate:modelValue":s[1]||(s[1]=r=>f.value=r),onChange:y,rows:"6",placeholder:"Привет! У тебя есть новые возможности. Проверь приложение!",class:"w-full px-4 py-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent resize-none"},null,544),[[T,f.value]]),e("p",Y,[s[9]||(s[9]=M(" Текст, который будет отправляться пользователям от имени бота. Поддерживается простой текст и emoji. ",-1)),s[10]||(s[10]=e("br",null,null,-1)),s[11]||(s[11]=M(" Доступные переменные: ",-1)),e("code",Z,a(t.username),1),s[12]||(s[12]=M(", ",-1)),e("code",ee,a(t.tickets_count),1)])])]),e("div",se,[e("div",te,[s[15]||(s[15]=e("div",{class:"flex-1"},[e("h3",{class:"text-base font-medium mb-1"},"Периодичность рассылки (в часах)"),e("p",{class:"text-sm text-muted-foreground"}," Интервал между отправками сообщений с момента регистрации или последнего события. Указывается в часах ")],-1)),e("div",re,[g(e("input",{"onUpdate:modelValue":s[2]||(s[2]=r=>p.value=r),onChange:y,type:"number",min:"1",max:"24",step:"1",class:"w-24 h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent text-center"},null,544),[[T,p.value,void 0,{number:!0}]]),s[14]||(s[14]=e("span",{class:"text-sm text-muted-foreground"},"часов",-1))])])]),e("div",ae,[e("div",oe,[s[17]||(s[17]=e("div",{class:"flex-1"},[e("h3",{class:"text-base font-medium mb-1"},"Триггер рассылки"),e("p",{class:"text-sm text-muted-foreground"}," Событие, после которого будет начинаться отсчёт до рассылки ")],-1)),e("div",le,[g(e("select",{"onUpdate:modelValue":s[3]||(s[3]=r=>x.value=r),onChange:y,class:"w-64 h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent"},[...s[16]||(s[16]=[e("option",{value:"after_registration"},"После регистрации",-1),e("option",{value:"after_last_spin"},"После последнего прокрута",-1)])],544),[[q,x.value]])])])]),e("div",de,[e("button",{onClick:y,disabled:w.value,class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[e("span",null,a(w.value?"Сохранение...":"Сохранить настройки"),1)],8,ne)]),e("div",ue,[e("div",null,[s[23]||(s[23]=e("h3",{class:"text-base font-medium mb-2"},"Тестовая отправка",-1)),s[24]||(s[24]=e("p",{class:"text-sm text-muted-foreground mb-4"}," Выберите пользователя для тестовой отправки сообщения и проверки работоспособности рассылки ",-1)),e("div",ie,[s[18]||(s[18]=e("label",{class:"text-sm font-medium mb-2 block"},"Поиск пользователя",-1)),g(e("input",{"onUpdate:modelValue":s[4]||(s[4]=r=>b.value=r),onInput:B,type:"text",placeholder:"Поиск по ID, username или имени...",class:"w-full h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent"},null,544),[[T,b.value]])]),_.value.length>0?(d(),l("div",ce,[(d(!0),l(H,null,L(_.value,r=>(d(),l("div",{key:r.id,onClick:Ve=>S(r),class:D(["px-4 py-3 border-b border-border last:border-b-0 cursor-pointer hover:bg-muted/10 transition-colors",u.value?.id===r.id?"bg-accent/10":""])},[e("div",ve,[e("div",null,[e("div",ge,a(r.name||"Без имени"),1),e("div",me," ID: "+a(r.id)+" | Telegram ID: "+a(r.telegram_id)+" | @"+a(r.username||"нет username"),1)]),u.value?.id===r.id?(d(),l("div",fe,"✓")):i("",!0)])],10,be))),128))])):b.value&&!j.value?(d(),l("div",pe," Пользователи не найдены ")):b.value?i("",!0):(d(),l("div",xe," Введите поисковый запрос для поиска пользователей ")),u.value?(d(),l("div",_e,[s[19]||(s[19]=e("div",{class:"text-sm font-medium mb-1"},"Выбранный пользователь:",-1)),e("div",ye,a(u.value.name||"Без имени")+" (ID: "+a(u.value.id)+", Telegram: "+a(u.value.telegram_id)+") ",1)])):i("",!0),e("div",he,[s[20]||(s[20]=e("label",{class:"text-sm font-medium mb-2 block"},"Тестовое сообщение (опционально)",-1)),g(e("textarea",{"onUpdate:modelValue":s[5]||(s[5]=r=>U.value=r),rows:"3",placeholder:"Оставьте пустым, чтобы использовать текст из настроек",class:"w-full px-4 py-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent resize-none"},null,512),[[T,U.value]]),s[21]||(s[21]=e("p",{class:"text-xs text-muted-foreground mt-1"}," Если оставить пустым, будет использован текст из настроек рассылки ",-1))]),e("button",{onClick:z,disabled:!u.value||k.value,class:"h-11 px-6 bg-blue-500/10 backdrop-blur-xl text-blue-600 border border-blue-500/40 hover:bg-blue-500/20 rounded-2xl shadow-lg shadow-blue-500/10 inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[e("span",null,a(k.value?"Отправка...":"Отправить тестовое сообщение"),1)],8,we),n.value?(d(),l("div",{key:4,class:D(["mt-4 p-4 rounded-lg",n.value.success?"bg-green-500/10 border border-green-500/20":"bg-destructive/10 border border-destructive/20"])},[e("div",{class:D([n.value.success?"text-green-600":"text-destructive","font-medium mb-1"])},a(n.value.success?"✓ Сообщение отправлено успешно":"✗ Ошибка отправки"),3),n.value.message?(d(),l("div",ke,a(n.value.message),1)):i("",!0),n.value.sent_message?(d(),l("div",Te,[s[22]||(s[22]=e("div",{class:"font-medium"},"Отправленное сообщение:",-1)),e("div",Ce,a(n.value.sent_message),1)])):i("",!0)],2)):i("",!0)])])]))]))}},De=E(je,[["__scopeId","data-v-69e4630d"]]);export{De as default};
