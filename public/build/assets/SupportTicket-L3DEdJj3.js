import{_ as P,c as i,a as r,b as m,t as c,f as q,F as w,q as W,d as G,v as K,w as J,r as p,m as L,n as Q,k as X,M as Y,i as Z,h as $,l as ee,j,N as te,o as d,p as B}from"./admin-BUNtZ2ka.js";import{S}from"./sweetalert2.esm.all-C0u8rGqG.js";import{S as se}from"./StatusBadge-CRvSy5xi.js";const re={name:"SupportTicket",components:{StatusBadge:se},setup(){const _=ee(),l=Z(),b=p(!1),s=p(null),h=p(null),g=p(""),u=p([]),o=p(!1),a=p(null),f=L(()=>h.value&&["open","in_progress"].includes(h.value.status)),F=L(()=>!h.value?.messages||!Array.isArray(h.value.messages)?[]:[...h.value.messages].sort((t,e)=>{const n=new Date(t.created_at||0),v=new Date(e.created_at||0);return n-v})),C=()=>({Authorization:`Bearer ${localStorage.getItem("token")}`,Accept:"application/json"}),k=async()=>{const t=_.params.id;if(!t){s.value="ID —Ç–∏–∫–µ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";return}b.value=!0,s.value=null;try{const e=await j.get(`/api/v1/support/tickets/${t}`,{headers:C()});e.data.success?(h.value=e.data.data,R()):s.value=e.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç"}catch(e){s.value=e.response?.data?.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–∫–µ—Ç–∞",console.error("Error fetching ticket:",e)}finally{b.value=!1}},R=()=>{te(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})},A=t=>{const e=Array.from(t.target.files);u.value=e.map(n=>(x(n)&&(n.previewUrl=URL.createObjectURL(n)),n))},I=t=>{const e=u.value[t];e&&x(e)&&e.previewUrl&&URL.revokeObjectURL(e.previewUrl),u.value.splice(t,1)},z=async()=>{if(!(!g.value.trim()&&u.value.length===0||!f.value)){o.value=!0;try{const t=new FormData;t.append("ticket_id",h.value.id),g.value.trim()&&t.append("message",g.value),u.value.forEach(n=>{t.append("attachments[]",n)});const e=await j.post("/api/v1/support/message",t,{headers:{...C(),"Content-Type":"multipart/form-data"}});e.data.success?(u.value.forEach(n=>{n&&n.previewUrl&&URL.revokeObjectURL(n.previewUrl)}),g.value="",u.value=[],await k()):S.fire("–û—à–∏–±–∫–∞",e.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}catch(t){S.fire("–û—à–∏–±–∫–∞",t.response?.data?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}finally{o.value=!1}}},D=t=>t?new Date(t).toLocaleString("ru-RU"):"",E=(t,e=2)=>{if(t===0)return"0 Bytes";const n=1024,v=e<0?0:e,U=["Bytes","KB","MB","GB"],y=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,y)).toFixed(v))+" "+U[y]},x=t=>t.type&&t.type.startsWith("image/"),T=t=>{const e=t.name?.toLowerCase()||"",n=t.mime_type?.toLowerCase()||"",v=t.url?.toLowerCase()||"",y=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"].some(M=>e.endsWith(M)||v.endsWith(M)),H=n.startsWith("image/");return y||H},O=t=>t&&x(t)?t.previewUrl||URL.createObjectURL(t):"",N=t=>{const e=t.name?.toLowerCase()||"",n=t.type?.toLowerCase()||"";return n.includes("pdf")||e.endsWith(".pdf")?"üìÑ":n.includes("word")||e.endsWith(".doc")||e.endsWith(".docx")?"üìù":n.includes("excel")||e.endsWith(".xls")||e.endsWith(".xlsx")?"üìä":n.includes("powerpoint")||e.endsWith(".ppt")||e.endsWith(".pptx")?"üìΩÔ∏è":e.endsWith(".txt")?"üìÉ":e.endsWith(".zip")||e.endsWith(".rar")||e.endsWith(".7z")?"üì¶":"üìé"},V=t=>{const e=t.name?.toLowerCase()||"",n=t.mime_type?.toLowerCase()||"";return n.includes("pdf")||e.endsWith(".pdf")?"üìÑ":n.includes("word")||e.endsWith(".doc")||e.endsWith(".docx")?"üìù":n.includes("excel")||e.endsWith(".xls")||e.endsWith(".xlsx")?"üìä":n.includes("powerpoint")||e.endsWith(".ppt")||e.endsWith(".pptx")?"üìΩÔ∏è":e.endsWith(".txt")?"üìÉ":e.endsWith(".zip")||e.endsWith(".rar")||e.endsWith(".7z")?"üì¶":"üìé"};return Q(()=>_.params.id,()=>{k()}),X(()=>{k()}),Y(()=>{u.value.forEach(t=>{t&&t.previewUrl&&URL.revokeObjectURL(t.previewUrl)})}),{router:l,loading:b,error:s,ticket:h,newMessage:g,attachments:u,sending:o,messagesContainer:a,isChatEnabled:f,sortedMessages:F,handleFileSelect:A,removeAttachment:I,sendMessage:z,formatDate:D,formatBytes:E,isImageFile:x,isImageAttachment:T,getFilePreview:O,getFileIcon:N,getAttachmentIcon:V}}},oe={class:"support-ticket-page"},ne={class:"mb-4"},ae={key:0,class:"flex items-center justify-center py-12"},ie={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg mb-4"},de={class:"text-destructive"},ce={key:2,class:"bg-card rounded-lg border border-border"},le={class:"p-4 border-b border-border"},ue={class:"flex items-start justify-between"},me={class:"flex-1"},he={class:"text-2xl font-semibold mb-2"},pe={class:"flex items-center gap-3"},ge={class:"text-sm text-muted-foreground"},fe={key:0,class:"text-sm text-muted-foreground"},ve={ref:"messagesContainer",class:"p-4 space-y-4 min-h-[400px] max-h-[600px] overflow-y-auto"},_e={class:"text-sm whitespace-pre-wrap mb-2"},be={key:0,class:"mt-2 space-y-2"},xe=["href"],ye=["src","alt"],ke={key:1,class:"flex-shrink-0"},we=["href"],We={class:"text-2xl"},Ce={class:"flex-1 min-w-0"},Ue=["href"],Me={key:1,class:"text-xs text-muted-foreground truncate block"},Le={key:2,class:"text-xs text-muted-foreground block"},je={class:"text-xs mt-2 opacity-70"},Be={key:0,class:"p-4 bg-yellow-500/10 border-t border-yellow-500/20 text-center text-sm text-yellow-600"},Se={key:1,class:"p-4 border-t border-border"},Fe={key:0,class:"mt-2 space-y-2"},Re={key:0,class:"flex-shrink-0"},Ae=["src","alt"],Ie={key:1,class:"flex-shrink-0"},ze={class:"w-16 h-16 flex items-center justify-center bg-muted rounded border border-border"},De={class:"text-2xl"},Ee={class:"flex-1 min-w-0"},Te={class:"text-sm font-medium truncate"},Oe={class:"text-xs text-muted-foreground"},Ne=["onClick"],Ve={class:"flex gap-3"},He=["disabled"];function Pe(_,l,b,s,h,g){const u=$("StatusBadge");return d(),i("div",oe,[r("div",ne,[r("button",{onClick:l[0]||(l[0]=o=>_.$router.push({name:"admin.support"})),class:"flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"}," ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–∏–∫–µ—Ç–æ–≤ ")]),s.loading?(d(),i("div",ae,[...l[4]||(l[4]=[r("p",{class:"text-muted-foreground"},"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–∞...",-1)])])):m("",!0),s.error?(d(),i("div",ie,[r("p",de,c(s.error),1)])):m("",!0),s.ticket&&!s.loading?(d(),i("div",ce,[r("div",le,[r("div",ue,[r("div",me,[r("h1",he,c(s.ticket.subject||s.ticket.theme),1),r("div",pe,[q(u,{status:s.ticket.status},null,8,["status"]),r("span",ge," –°–æ–∑–¥–∞–Ω: "+c(s.formatDate(s.ticket.created_at)),1),s.ticket.messages?.length?(d(),i("span",fe," –°–æ–æ–±—â–µ–Ω–∏–π: "+c(s.ticket.messages.length),1)):m("",!0)])])])]),r("div",ve,[(d(!0),i(w,null,W(s.sortedMessages,o=>(d(),i("div",{key:o.id,class:B(["flex",o.sender==="tma"?"justify-end":"justify-start"])},[r("div",{class:B(["max-w-[70%] rounded-lg p-3",o.sender==="tma"?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground"])},[r("p",_e,c(o.body||o.message||""),1),o.attachments&&o.attachments.length>0?(d(),i("div",be,[(d(!0),i(w,null,W(o.attachments,(a,f)=>(d(),i("div",{key:f,class:"flex items-start gap-2"},[a.url&&s.isImageAttachment(a)?(d(),i("a",{key:0,href:a.url,target:"_blank",class:"flex-shrink-0 hover:opacity-80 transition-opacity"},[r("img",{src:a.url,alt:a.name,class:"w-20 h-20 object-cover rounded border border-border/50"},null,8,ye)],8,xe)):a.url?(d(),i("div",ke,[r("a",{href:a.url,target:"_blank",class:"block w-16 h-16 flex items-center justify-center bg-muted/50 rounded border border-border/50 hover:bg-muted transition-colors"},[r("span",We,c(s.getAttachmentIcon(a)),1)],8,we)])):m("",!0),r("div",Ce,[a.url?(d(),i("a",{key:0,href:a.url,target:"_blank",class:"text-xs underline flex items-center gap-1 hover:opacity-80 block truncate"},c(a.name),9,Ue)):(d(),i("span",Me,c(a.name),1)),a.size?(d(),i("span",Le,c(s.formatBytes(a.size)),1)):m("",!0)])]))),128))])):m("",!0),r("p",je,c(o.sender==="tma"?"–í—ã":"CRM")+" ‚Ä¢ "+c(s.formatDate(o.created_at)),1)],2)],2))),128))],512),s.isChatEnabled?m("",!0):(d(),i("div",Be," –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ ")),s.isChatEnabled?(d(),i("div",Se,[r("form",{onSubmit:l[3]||(l[3]=J((...o)=>s.sendMessage&&s.sendMessage(...o),["prevent"])),class:"space-y-3"},[r("div",null,[G(r("textarea",{"onUpdate:modelValue":l[1]||(l[1]=o=>s.newMessage=o),rows:"3",placeholder:"–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",class:"w-full px-3 py-2 border border-border rounded bg-background resize-none"},null,512),[[K,s.newMessage]])]),r("div",null,[r("input",{type:"file",onChange:l[2]||(l[2]=(...o)=>s.handleFileSelect&&s.handleFileSelect(...o)),multiple:"",accept:"image/*,.pdf,.doc,.docx,.txt",class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},null,32),s.attachments.length>0?(d(),i("div",Fe,[(d(!0),i(w,null,W(s.attachments,(o,a)=>(d(),i("div",{key:a,class:"flex items-start gap-3 p-2 border border-border rounded bg-background"},[s.isImageFile(o)?(d(),i("div",Re,[r("img",{src:s.getFilePreview(o),alt:o.name,class:"w-16 h-16 object-cover rounded border border-border"},null,8,Ae)])):(d(),i("div",Ie,[r("div",ze,[r("span",De,c(s.getFileIcon(o)),1)])])),r("div",Ee,[r("p",Te,c(o.name),1),r("p",Oe,c(s.formatBytes(o.size)),1)]),r("button",{type:"button",onClick:f=>s.removeAttachment(a),class:"flex-shrink-0 p-1 text-destructive hover:text-destructive/80 hover:bg-destructive/10 rounded transition-colors"}," ‚úï ",8,Ne)]))),128))])):m("",!0)]),r("div",Ve,[r("button",{type:"submit",disabled:s.sending||!s.newMessage.trim()&&s.attachments.length===0,class:"px-4 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/90 disabled:opacity-50 transition-colors"},c(s.sending?"–û—Ç–ø—Ä–∞–≤–∫–∞...":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å"),9,He)])],32)])):m("",!0)])):m("",!0)])}const Je=P(re,[["render",Pe]]);export{Je as default};
