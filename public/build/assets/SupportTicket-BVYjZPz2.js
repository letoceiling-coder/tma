import{_ as R,c as o,a,b as i,t as d,f as I,F as y,q as k,d as L,v as H,w as U,r as f,m as S,n as q,k as G,i as K,h as J,l as O,j as C,L as P,o as r,p as D,e as Q}from"./admin-CVJgAGJK.js";import{S as w}from"./sweetalert2.esm.all-C0u8rGqG.js";import{S as W}from"./StatusBadge-SoJ7b3PT.js";const X={name:"SupportTicket",components:{StatusBadge:W},setup(){const h=O(),c=K(),_=f(!1),e=f(null),u=f(null),g=f(""),m=f([]),t=f(!1),l=f(null),v=S(()=>u.value&&["open","in_progress"].includes(u.value.status)),A=S(()=>!u.value?.messages||!Array.isArray(u.value.messages)?[]:[...u.value.messages].sort((s,n)=>{const p=new Date(s.created_at||0),x=new Date(n.created_at||0);return p-x})),M=()=>({Authorization:`Bearer ${localStorage.getItem("token")}`,Accept:"application/json"}),b=async()=>{const s=h.params.id;if(!s){e.value="ID —Ç–∏–∫–µ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";return}_.value=!0,e.value=null;try{const n=await C.get(`/api/v1/support/tickets/${s}`,{headers:M()});n.data.success?(u.value=n.data.data,T()):e.value=n.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç"}catch(n){e.value=n.response?.data?.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–∫–µ—Ç–∞",console.error("Error fetching ticket:",n)}finally{_.value=!1}},T=()=>{P(()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)})},j=s=>{const n=Array.from(s.target.files);m.value=n},F=s=>{m.value.splice(s,1)},z=async()=>{if(!(!g.value.trim()&&m.value.length===0||!v.value)){t.value=!0;try{const s=new FormData;s.append("ticket_id",u.value.id),g.value.trim()&&s.append("message",g.value),m.value.forEach(p=>{s.append("attachments[]",p)});const n=await C.post("/api/v1/support/message",s,{headers:{...M(),"Content-Type":"multipart/form-data"}});n.data.success?(g.value="",m.value=[],await b(),w.fire("–£—Å–ø–µ—Ö","–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ","success")):w.fire("–û—à–∏–±–∫–∞",n.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}catch(s){w.fire("–û—à–∏–±–∫–∞",s.response?.data?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}finally{t.value=!1}}},E=s=>s?new Date(s).toLocaleString("ru-RU"):"",V=(s,n=2)=>{if(s===0)return"0 Bytes";const p=1024,x=n<0?0:n,N=["Bytes","KB","MB","GB"],B=Math.floor(Math.log(s)/Math.log(p));return parseFloat((s/Math.pow(p,B)).toFixed(x))+" "+N[B]};return q(()=>h.params.id,()=>{b()}),G(()=>{b()}),{router:c,loading:_,error:e,ticket:u,newMessage:g,attachments:m,sending:t,messagesContainer:l,isChatEnabled:v,sortedMessages:A,handleFileSelect:j,removeAttachment:F,sendMessage:z,formatDate:E,formatBytes:V}}},Y={class:"support-ticket-page"},Z={class:"mb-4"},$={key:0,class:"flex items-center justify-center py-12"},ee={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg mb-4"},te={class:"text-destructive"},se={key:2,class:"bg-card rounded-lg border border-border"},ae={class:"p-4 border-b border-border"},oe={class:"flex items-start justify-between"},re={class:"flex-1"},ne={class:"text-2xl font-semibold mb-2"},le={class:"flex items-center gap-3"},ce={class:"text-sm text-muted-foreground"},de={key:0,class:"text-sm text-muted-foreground"},ie={ref:"messagesContainer",class:"p-4 space-y-4 min-h-[400px] max-h-[600px] overflow-y-auto"},ue={class:"text-sm whitespace-pre-wrap mb-2"},me={key:0,class:"mt-2 space-y-2"},fe=["href"],ge={key:0,class:"opacity-70"},pe={class:"text-xs mt-2 opacity-70"},ve={key:0,class:"p-4 bg-yellow-500/10 border-t border-yellow-500/20 text-center text-sm text-yellow-600"},he={key:1,class:"p-4 border-t border-border"},_e={key:0,class:"mt-2 space-y-1"},be=["onClick"],xe={class:"flex gap-3"},ye=["disabled"];function ke(h,c,_,e,u,g){const m=J("StatusBadge");return r(),o("div",Y,[a("div",Z,[a("button",{onClick:c[0]||(c[0]=t=>h.$router.push({name:"admin.support"})),class:"flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"}," ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–∏–∫–µ—Ç–æ–≤ ")]),e.loading?(r(),o("div",$,[...c[4]||(c[4]=[a("p",{class:"text-muted-foreground"},"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–∞...",-1)])])):i("",!0),e.error?(r(),o("div",ee,[a("p",te,d(e.error),1)])):i("",!0),e.ticket&&!e.loading?(r(),o("div",se,[a("div",ae,[a("div",oe,[a("div",re,[a("h1",ne,d(e.ticket.subject||e.ticket.theme),1),a("div",le,[I(m,{status:e.ticket.status},null,8,["status"]),a("span",ce," –°–æ–∑–¥–∞–Ω: "+d(e.formatDate(e.ticket.created_at)),1),e.ticket.messages?.length?(r(),o("span",de," –°–æ–æ–±—â–µ–Ω–∏–π: "+d(e.ticket.messages.length),1)):i("",!0)])])])]),a("div",ie,[(r(!0),o(y,null,k(e.sortedMessages,t=>(r(),o("div",{key:t.id,class:D(["flex",t.sender==="tma"?"justify-end":"justify-start"])},[a("div",{class:D(["max-w-[70%] rounded-lg p-3",t.sender==="tma"?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground"])},[a("p",ue,d(t.body||t.message||""),1),t.attachments&&t.attachments.length>0?(r(),o("div",me,[(r(!0),o(y,null,k(t.attachments,(l,v)=>(r(),o("div",{key:v,class:"flex items-center gap-2"},[l.url?(r(),o("a",{key:0,href:l.url,target:"_blank",class:"text-xs underline flex items-center gap-1 hover:opacity-80"},[Q(" üìé "+d(l.name)+" ",1),l.size?(r(),o("span",ge," ("+d(e.formatBytes(l.size))+") ",1)):i("",!0)],8,fe)):i("",!0)]))),128))])):i("",!0),a("p",pe,d(t.sender==="tma"?"–í—ã":"CRM")+" ‚Ä¢ "+d(e.formatDate(t.created_at)),1)],2)],2))),128))],512),e.isChatEnabled?i("",!0):(r(),o("div",ve," –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ ")),e.isChatEnabled?(r(),o("div",he,[a("form",{onSubmit:c[3]||(c[3]=U((...t)=>e.sendMessage&&e.sendMessage(...t),["prevent"])),class:"space-y-3"},[a("div",null,[L(a("textarea",{"onUpdate:modelValue":c[1]||(c[1]=t=>e.newMessage=t),rows:"3",placeholder:"–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",class:"w-full px-3 py-2 border border-border rounded bg-background resize-none"},null,512),[[H,e.newMessage]])]),a("div",null,[a("input",{type:"file",onChange:c[2]||(c[2]=(...t)=>e.handleFileSelect&&e.handleFileSelect(...t)),multiple:"",accept:"image/*,.pdf,.doc,.docx,.txt",class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},null,32),e.attachments.length>0?(r(),o("div",_e,[(r(!0),o(y,null,k(e.attachments,(t,l)=>(r(),o("div",{key:l,class:"text-sm text-muted-foreground flex items-center justify-between"},[a("span",null,d(t.name),1),a("button",{type:"button",onClick:v=>e.removeAttachment(l),class:"text-destructive hover:text-destructive/80"}," ‚úï ",8,be)]))),128))])):i("",!0)]),a("div",xe,[a("button",{type:"submit",disabled:e.sending||!e.newMessage.trim()&&e.attachments.length===0,class:"px-4 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/90 disabled:opacity-50 transition-colors"},d(e.sending?"–û—Ç–ø—Ä–∞–≤–∫–∞...":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å"),9,ye)])],32)])):i("",!0)])):i("",!0)])}const Se=R(X,[["render",ke]]);export{Se as default};
