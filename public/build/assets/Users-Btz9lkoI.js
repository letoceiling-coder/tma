import{_ as z,c as n,a as e,b as f,d as v,v as U,C as D,F as y,q as _,t as d,w as G,e as H,r as m,m as P,k as J,u as K,o as l,p as Q,D as W}from"./admin-DaTN_OsE.js";import{a as V,b as X,c as Y,d as Z}from"./api-DccBIR6h.js";import{S as k}from"./sweetalert2.esm.all-C0u8rGqG.js";const $={name:"Users",setup(){const E=K(),o=m(!1),C=m(!1),t=m(null),h=m([]),M=m([]),r=m(null),c=m(!1),w=m(!1),i=m({search:"",role_id:"",sort_by:"id",sort_order:"desc",page:1,per_page:15}),g=m({id:null,name:"",email:"",password:"",roles:[]}),T=P(()=>E.getters.user?.id);let S=null;const q=()=>{S&&clearTimeout(S),S=setTimeout(()=>{i.value.page=1,x()},500)},R=P(()=>{if(!r.value)return[];const s=r.value.current_page,a=r.value.last_page,u=[];let p=Math.max(1,s-3),b=Math.min(a,s+3);s<=4&&(b=Math.min(7,a)),s>=a-3&&(p=Math.max(1,a-6));for(let B=p;B<=b;B++)u.push(B);return u}),x=async()=>{o.value=!0,t.value=null;try{const s=new URLSearchParams;i.value.search&&s.append("search",i.value.search),i.value.role_id&&s.append("role_id",i.value.role_id),s.append("sort_by",i.value.sort_by),s.append("sort_order",i.value.sort_order),s.append("page",i.value.page.toString()),s.append("per_page",i.value.per_page.toString());const a=s.toString(),u=a?`/users?${a}`:"/users",p=await V(u);if(!p.ok)throw new Error("Ошибка загрузки пользователей");const b=await p.json();b.data&&Array.isArray(b.data)?(h.value=b.data,b.meta&&(r.value=b.meta)):Array.isArray(b)?(h.value=b,r.value=null):(h.value=[],r.value=null)}catch(s){t.value=s.message||"Ошибка загрузки пользователей"}finally{o.value=!1}},F=s=>{s>=1&&s<=(r.value?.last_page||1)&&(i.value.page=s,x())},I=()=>{i.value.sort_order=i.value.sort_order==="asc"?"desc":"asc",x()},A=async()=>{try{const s=await V("/roles");if(!s.ok)throw new Error("Ошибка загрузки ролей");const a=await s.json();M.value=a.data||[]}catch(s){console.error("Error fetching roles:",s)}},L=s=>{g.value={id:s.id,name:s.name,email:s.email,password:"",roles:s.roles.map(a=>a.id)},w.value=!0},N=async s=>{if((await k.fire({title:"Удалить пользователя?",html:`Вы уверены, что хотите удалить пользователя <strong>"${s.name}"</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить",cancelButtonText:"Отмена",confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280"})).isConfirmed)try{const u=await Z(`/users/${s.id}`);if(!u.ok){const p=await u.json();throw new Error(p.message||"Ошибка удаления пользователя")}await k.fire({title:"Пользователь удален",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),await x()}catch(u){k.fire({title:"Ошибка",text:u.message||"Ошибка удаления пользователя",icon:"error",confirmButtonText:"ОК"})}},O=async()=>{C.value=!0,t.value=null;try{const s={name:g.value.name,email:g.value.email,roles:g.value.roles};g.value.password&&(s.password=g.value.password);let a;if(w.value?a=await X(`/users/${g.value.id}`,s):a=await Y("/users",s),!a.ok){const u=await a.json();throw new Error(u.message||"Ошибка сохранения пользователя")}await k.fire({title:w.value?"Пользователь обновлен":"Пользователь создан",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),j(),await x()}catch(s){t.value=s.message||"Ошибка сохранения пользователя",k.fire({title:"Ошибка",text:s.message||"Ошибка сохранения пользователя",icon:"error",confirmButtonText:"ОК"})}finally{C.value=!1}},j=()=>{c.value=!1,w.value=!1,g.value={id:null,name:"",email:"",password:"",roles:[]}};return J(async()=>{await Promise.all([x(),A()])}),{loading:o,saving:C,error:t,users:h,allRoles:M,pagination:r,filters:i,visiblePages:R,showCreateModal:c,showEditModal:w,form:g,currentUserId:T,editUser:L,deleteUser:N,saveUser:O,closeModal:j,fetchUsers:x,changePage:F,toggleSortOrder:I,debouncedFetchUsers:q}}},ee={class:"users-page space-y-6"},te={class:"flex items-center justify-between mb-6"},oe={class:"bg-card rounded-lg border border-border p-4 mb-6"},re={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},se=["value"],ne={class:"flex gap-2"},le=["title"],ae={key:0,class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},de={key:1,class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ie={key:0,class:"flex items-center justify-center py-12"},ue={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},ce={class:"text-destructive"},be={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},me={class:"overflow-x-auto"},ge={class:"w-full"},fe={class:"divide-y divide-border"},xe={class:"px-6 py-4 text-sm text-foreground"},pe={class:"px-6 py-4 text-sm font-medium text-foreground"},ve={class:"px-6 py-4 text-sm text-foreground"},he={class:"px-6 py-4 text-sm text-foreground"},we={class:"flex flex-wrap gap-1"},ye={key:0,class:"text-muted-foreground text-xs"},_e={class:"px-6 py-4 text-sm text-muted-foreground"},ke={class:"px-6 py-4 text-sm text-right"},Ce={class:"flex items-center justify-end gap-2"},Ue=["onClick"],Me=["onClick","disabled"],Se={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},Be={key:4,class:"flex items-center justify-between bg-card rounded-lg border border-border p-4"},Ee={class:"text-sm text-muted-foreground"},je={class:"flex items-center gap-2"},De=["disabled"],Pe={class:"flex items-center gap-1"},Ve=["onClick"],Te=["disabled"],qe={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"},Re={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md p-6"},Fe={class:"text-lg font-semibold mb-4"},Ie={class:"text-sm font-medium mb-1 block"},Ae={key:0,class:"text-xs text-muted-foreground"},Le=["required"],Ne={class:"space-y-2 max-h-48 overflow-y-auto border border-border rounded p-2"},Oe=["value"],ze={class:"text-sm"},Ge={class:"flex gap-2 pt-4"},He=["disabled"];function Je(E,o,C,t,h,M){return l(),n("div",ee,[e("div",te,[o[17]||(o[17]=e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Пользователи"),e("p",{class:"text-muted-foreground mt-1"},"Управление пользователями системы")],-1)),e("button",{onClick:o[0]||(o[0]=r=>t.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...o[16]||(o[16]=[e("span",null,"+",-1),e("span",null,"Создать пользователя",-1)])])]),e("div",oe,[e("div",re,[e("div",null,[o[18]||(o[18]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Поиск",-1)),v(e("input",{"onUpdate:modelValue":o[1]||(o[1]=r=>t.filters.search=r),onInput:o[2]||(o[2]=(...r)=>t.debouncedFetchUsers&&t.debouncedFetchUsers(...r)),type:"text",placeholder:"Имя или email...",class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,544),[[U,t.filters.search]])]),e("div",null,[o[20]||(o[20]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Роль",-1)),v(e("select",{"onUpdate:modelValue":o[3]||(o[3]=r=>t.filters.role_id=r),onChange:o[4]||(o[4]=(...r)=>t.fetchUsers&&t.fetchUsers(...r)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[o[19]||(o[19]=e("option",{value:""},"Все роли",-1)),(l(!0),n(y,null,_(t.allRoles,r=>(l(),n("option",{key:r.id,value:r.id},d(r.name),9,se))),128))],544),[[D,t.filters.role_id]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Сортировка",-1)),e("div",ne,[v(e("select",{"onUpdate:modelValue":o[5]||(o[5]=r=>t.filters.sort_by=r),onChange:o[6]||(o[6]=(...r)=>t.fetchUsers&&t.fetchUsers(...r)),class:"flex-1 h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[...o[21]||(o[21]=[e("option",{value:"id"},"ID",-1),e("option",{value:"name"},"Имя",-1),e("option",{value:"email"},"Email",-1),e("option",{value:"created_at"},"Дата создания",-1)])],544),[[D,t.filters.sort_by]]),e("button",{onClick:o[7]||(o[7]=(...r)=>t.toggleSortOrder&&t.toggleSortOrder(...r)),class:"h-10 w-10 border border-border rounded-lg bg-background hover:bg-muted/10 flex items-center justify-center",title:t.filters.sort_order==="asc"?"По возрастанию":"По убыванию"},[t.filters.sort_order==="asc"?(l(),n("svg",ae,[...o[22]||(o[22]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 15l7-7 7 7"},null,-1)])])):(l(),n("svg",de,[...o[23]||(o[23]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])]))],8,le)])])])]),t.loading?(l(),n("div",ie,[...o[25]||(o[25]=[e("p",{class:"text-muted-foreground"},"Загрузка пользователей...",-1)])])):f("",!0),t.error?(l(),n("div",ue,[e("p",ce,d(t.error),1)])):f("",!0),!t.loading&&t.users.length>0?(l(),n("div",be,[e("div",me,[e("table",ge,[o[26]||(o[26]=e("thead",{class:"bg-muted/30 border-b border-border"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"ID"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Имя"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Email"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Роли"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Дата создания"),e("th",{class:"px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase"},"Действия")])],-1)),e("tbody",fe,[(l(!0),n(y,null,_(t.users,r=>(l(),n("tr",{key:r.id,class:"hover:bg-muted/10"},[e("td",xe,d(r.id),1),e("td",pe,d(r.name),1),e("td",ve,d(r.email),1),e("td",he,[e("div",we,[(l(!0),n(y,null,_(r.roles,c=>(l(),n("span",{key:c.id,class:"px-2 py-1 text-xs rounded-md bg-accent/10 text-accent"},d(c.name),1))),128)),r.roles.length===0?(l(),n("span",ye,"Нет ролей")):f("",!0)])]),e("td",_e,d(new Date(r.created_at).toLocaleDateString("ru-RU")),1),e("td",ke,[e("div",Ce,[e("button",{onClick:c=>t.editUser(r),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Редактировать ",8,Ue),e("button",{onClick:c=>t.deleteUser(r),disabled:r.id===t.currentUserId,class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Удалить ",8,Me)])])]))),128))])])])])):f("",!0),!t.loading&&t.users.length===0?(l(),n("div",Se,[...o[27]||(o[27]=[e("p",{class:"text-muted-foreground"},"Пользователи не найдены",-1)])])):f("",!0),!t.loading&&t.pagination&&t.pagination.last_page>1?(l(),n("div",Be,[e("div",Ee," Показано "+d(t.pagination.from)+" - "+d(t.pagination.to)+" из "+d(t.pagination.total),1),e("div",je,[e("button",{onClick:o[8]||(o[8]=r=>t.changePage(t.pagination.current_page-1)),disabled:t.pagination.current_page===1,class:"px-3 py-2 text-sm border border-border rounded-lg bg-background hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Назад ",8,De),e("div",Pe,[(l(!0),n(y,null,_(t.visiblePages,r=>(l(),n("button",{key:r,onClick:c=>t.changePage(r),class:Q(["px-3 py-2 text-sm border rounded-lg transition-colors",r===t.pagination.current_page?"bg-accent/10 text-accent border-accent/40":"bg-background border-border hover:bg-muted/10"])},d(r),11,Ve))),128))]),e("button",{onClick:o[9]||(o[9]=r=>t.changePage(t.pagination.current_page+1)),disabled:t.pagination.current_page===t.pagination.last_page,class:"px-3 py-2 text-sm border border-border rounded-lg bg-background hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Вперед ",8,Te)])])):f("",!0),t.showCreateModal||t.showEditModal?(l(),n("div",qe,[e("div",Re,[e("h3",Fe,d(t.showEditModal?"Редактировать пользователя":"Создать пользователя"),1),e("form",{onSubmit:o[15]||(o[15]=G((...r)=>t.saveUser&&t.saveUser(...r),["prevent"])),class:"space-y-4"},[e("div",null,[o[28]||(o[28]=e("label",{class:"text-sm font-medium mb-1 block"},"Имя",-1)),v(e("input",{"onUpdate:modelValue":o[10]||(o[10]=r=>t.form.name=r),type:"text",required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[U,t.form.name]])]),e("div",null,[o[29]||(o[29]=e("label",{class:"text-sm font-medium mb-1 block"},"Email",-1)),v(e("input",{"onUpdate:modelValue":o[11]||(o[11]=r=>t.form.email=r),type:"email",required:"",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,512),[[U,t.form.email]])]),e("div",null,[e("label",Ie,[o[30]||(o[30]=H(" Пароль ",-1)),t.showEditModal?(l(),n("span",Ae,"(оставьте пустым, чтобы не менять)")):f("",!0)]),v(e("input",{"onUpdate:modelValue":o[12]||(o[12]=r=>t.form.password=r),type:"password",required:!t.showEditModal,minlength:8,class:"w-full h-10 px-3 border border-border rounded bg-background"},null,8,Le),[[U,t.form.password]])]),e("div",null,[o[31]||(o[31]=e("label",{class:"text-sm font-medium mb-1 block"},"Роли",-1)),e("div",Ne,[(l(!0),n(y,null,_(t.allRoles,r=>(l(),n("label",{key:r.id,class:"flex items-center gap-2 cursor-pointer hover:bg-muted/10 p-2 rounded"},[v(e("input",{type:"checkbox",value:r.id,"onUpdate:modelValue":o[13]||(o[13]=c=>t.form.roles=c),class:"w-4 h-4"},null,8,Oe),[[W,t.form.roles]]),e("span",ze,d(r.name),1)]))),128))])]),e("div",Ge,[e("button",{type:"button",onClick:o[14]||(o[14]=(...r)=>t.closeModal&&t.closeModal(...r)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),e("button",{type:"submit",disabled:t.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},d(t.saving?"Сохранение...":"Сохранить"),9,He)])],32)])])):f("",!0)])}const Xe=z($,[["render",Je]]);export{Xe as default};
