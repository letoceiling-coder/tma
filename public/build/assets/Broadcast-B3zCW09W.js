import{_ as $,r as d,k as G,c as o,a as e,b as u,t as a,d as m,D as J,v as h,e as T,C as K,p as C,F as N,q as R,j,o as l}from"./admin-CbEWicFl.js";const P={class:"broadcast-page space-y-6"},Q={key:0,class:"flex items-center justify-center py-12"},W={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},X={class:"text-destructive"},Y={key:2,class:"p-4 bg-green-500/10 border border-green-500/20 rounded-lg"},Z={class:"text-green-600"},ee={key:3,class:"space-y-6"},se={class:"bg-card rounded-lg border border-border p-6"},te={class:"flex items-center justify-between"},ae={class:"relative inline-flex items-center cursor-pointer"},re={class:"bg-card rounded-lg border border-border p-6 space-y-4"},oe={class:"text-xs text-muted-foreground mt-1"},le={class:"bg-muted px-1 rounded"},de={class:"bg-muted px-1 rounded"},ne={class:"bg-card rounded-lg border border-border p-6"},ue={class:"flex items-center justify-between"},ie={class:"flex items-center gap-3"},ce={class:"bg-card rounded-lg border border-border p-6"},ve={class:"flex items-center justify-between"},be={class:"flex items-center gap-3"},me={class:"flex justify-end"},ge=["disabled"],fe={class:"bg-card rounded-lg border border-border p-6 space-y-4"},pe={key:0,class:"mb-4 p-3 bg-muted/30 rounded-lg"},xe={class:"text-sm text-muted-foreground"},_e={class:"mb-4"},ye={class:"text-xs text-muted-foreground mt-1"},we={class:"bg-muted px-1 rounded"},ke={class:"bg-muted px-1 rounded"},he=["disabled"],Te={key:0,class:"text-sm text-muted-foreground space-y-1"},Ce={class:"text-green-600"},je={key:0,class:"text-destructive"},Ue={key:1,class:"text-yellow-600"},Be={key:1,class:"mt-2 text-xs text-muted-foreground"},Me={class:"max-h-32 overflow-y-auto space-y-1"},Ve={class:"bg-card rounded-lg border border-border p-6 space-y-4"},De={class:"mb-4"},Ie={key:0,class:"mb-4 max-h-64 overflow-y-auto border border-border rounded-lg"},Se=["onClick"],ze={class:"flex items-center justify-between"},Ee={class:"text-sm font-medium"},Ne={class:"text-xs text-muted-foreground"},Re={key:0,class:"text-accent"},Fe={key:1,class:"mb-4 text-sm text-muted-foreground text-center py-4"},Le={key:2,class:"mb-4 text-sm text-muted-foreground text-center py-4"},qe={key:3,class:"mb-4 p-3 bg-muted/30 rounded-lg"},Ae={class:"text-sm text-muted-foreground"},He={class:"mb-4"},Oe=["disabled"],$e={key:0,class:"text-sm text-muted-foreground"},Ge={key:1,class:"text-sm text-muted-foreground mt-2"},Je={class:"mt-1 p-2 bg-background rounded border border-border"},Ke={__name:"Broadcast",setup(Pe){const U=d(!0),B=d(!1),c=d(null),g=d(null),p=d(!1),x=d(""),_=d(24),y=d("after_registration"),M=d(null),b=d(""),w=d([]),I=d(!1),v=d(null),S=d(""),V=d(!1),i=d(null),f=d(""),D=d(!1),n=d(null);let z=null;const F=async()=>{U.value=!0,c.value=null,g.value=null;try{const t=await j.get("/api/v1/wow/wheel/settings");if(t.data.settings){const s=t.data.settings;p.value=s.broadcast_enabled??!1,x.value=s.broadcast_message_text??"",_.value=s.broadcast_interval_hours??24,y.value=s.broadcast_trigger??"after_registration",M.value=s.manual_broadcast_at||null}}catch(t){c.value=t.response?.data?.message||"Ошибка загрузки настроек"}finally{U.value=!1}},k=async()=>{B.value=!0,c.value=null,g.value=null;try{const t=await j.put("/api/v1/wow/wheel/settings",{broadcast_enabled:p.value,broadcast_message_text:x.value,broadcast_interval_hours:_.value,broadcast_trigger:y.value});if(t.data.success){if(g.value="Настройки успешно сохранены",t.data.settings){const s=t.data.settings;p.value=s.broadcast_enabled??!1,x.value=s.broadcast_message_text??"",_.value=s.broadcast_interval_hours??24,y.value=s.broadcast_trigger??"after_registration"}setTimeout(()=>{g.value=null},3e3)}}catch(t){c.value=t.response?.data?.message||"Ошибка сохранения настроек"}finally{B.value=!1}},L=async()=>{if(z&&clearTimeout(z),!b.value||b.value.length<2){w.value=[];return}z=setTimeout(async()=>{I.value=!0;try{const t=await j.get("/api/v1/wow/users",{params:{search:b.value,per_page:20}});w.value=t.data.data||[]}catch(t){console.error("Error searching users:",t),w.value=[]}finally{I.value=!1}},500)},q=t=>{v.value=t,i.value=null},A=async()=>{if(v.value){V.value=!0,i.value=null,c.value=null;try{const t=await j.post("/api/v1/wow/wheel/test-broadcast",{user_id:v.value.id,message:S.value||null});t.data.success?i.value={success:!0,message:t.data.message,sent_message:t.data.sent_message}:i.value={success:!1,message:t.data.message||"Ошибка отправки",error_code:t.data.error_code,error_description:t.data.error_description}}catch(t){i.value={success:!1,message:t.response?.data?.message||"Ошибка отправки сообщения"}}finally{V.value=!1}}},H=async()=>{if(!f.value||!f.value.trim()){c.value="Введите текст сообщения для разовой рассылки";return}confirm("Вы уверены, что хотите отправить сообщение всем пользователям прямо сейчас?")&&await O()},O=async()=>{D.value=!0,n.value=null,c.value=null;try{const t=await j.post("/api/v1/wow/wheel/manual-broadcast",{message:f.value});t.data.success?(n.value={success:!0,message:t.data.message,stats:t.data.stats,errors:t.data.errors||[]},M.value=new Date().toISOString()):n.value={success:!1,message:t.data.message||"Ошибка при рассылке"}}catch(t){n.value={success:!1,message:t.response?.data?.message||"Ошибка отправки рассылки"},c.value=t.response?.data?.message||"Ошибка отправки рассылки"}finally{D.value=!1}};return G(()=>{F()}),(t,s)=>(l(),o("div",P,[s[33]||(s[33]=e("div",{class:"flex items-center justify-between"},[e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Рассылки"),e("p",{class:"text-muted-foreground mt-1"},"Управление автоматическими рассылками от Telegram-бота")])],-1)),U.value?(l(),o("div",Q,[...s[7]||(s[7]=[e("div",{class:"text-muted-foreground"},"Загрузка...",-1)])])):u("",!0),c.value?(l(),o("div",W,[e("p",X,a(c.value),1)])):u("",!0),g.value?(l(),o("div",Y,[e("p",Z,a(g.value),1)])):u("",!0),U.value?u("",!0):(l(),o("div",ee,[e("div",se,[e("div",te,[s[9]||(s[9]=e("div",null,[e("h3",{class:"text-base font-medium mb-1"},"Включить рассылки"),e("p",{class:"text-sm text-muted-foreground"}," Включает или выключает систему автоматических рассылок ")],-1)),e("label",ae,[m(e("input",{"onUpdate:modelValue":s[0]||(s[0]=r=>p.value=r),onChange:k,type:"checkbox",class:"sr-only peer"},null,544),[[J,p.value]]),s[8]||(s[8]=e("div",{class:"w-11 h-6 bg-muted peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-border after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"},null,-1))])])]),e("div",re,[e("div",null,[s[14]||(s[14]=e("label",{class:"text-sm font-medium mb-2 block"},"Текст рассылки",-1)),m(e("textarea",{"onUpdate:modelValue":s[1]||(s[1]=r=>x.value=r),onChange:k,rows:"6",placeholder:"Привет! У тебя есть новые возможности. Проверь приложение!",class:"w-full px-4 py-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent resize-none"},null,544),[[h,x.value]]),e("p",oe,[s[10]||(s[10]=T(" Текст, который будет отправляться пользователям от имени бота. Поддерживается простой текст и emoji. ",-1)),s[11]||(s[11]=e("br",null,null,-1)),s[12]||(s[12]=T(" Доступные переменные: ",-1)),e("code",le,a(t.username),1),s[13]||(s[13]=T(", ",-1)),e("code",de,a(t.tickets_count),1)])])]),e("div",ne,[e("div",ue,[s[16]||(s[16]=e("div",{class:"flex-1"},[e("h3",{class:"text-base font-medium mb-1"},"Периодичность рассылки (в часах)"),e("p",{class:"text-sm text-muted-foreground"}," Интервал между отправками сообщений с момента регистрации или последнего события. Указывается в часах ")],-1)),e("div",ie,[m(e("input",{"onUpdate:modelValue":s[2]||(s[2]=r=>_.value=r),onChange:k,type:"number",min:"1",max:"24",step:"1",class:"w-24 h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent text-center"},null,544),[[h,_.value,void 0,{number:!0}]]),s[15]||(s[15]=e("span",{class:"text-sm text-muted-foreground"},"часов",-1))])])]),e("div",ce,[e("div",ve,[s[18]||(s[18]=e("div",{class:"flex-1"},[e("h3",{class:"text-base font-medium mb-1"},"Триггер рассылки"),e("p",{class:"text-sm text-muted-foreground"}," Событие, после которого будет начинаться отсчёт до рассылки ")],-1)),e("div",be,[m(e("select",{"onUpdate:modelValue":s[3]||(s[3]=r=>y.value=r),onChange:k,class:"w-64 h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent"},[...s[17]||(s[17]=[e("option",{value:"after_registration"},"После регистрации",-1),e("option",{value:"after_last_spin"},"После последнего прокрута",-1)])],544),[[K,y.value]])])])]),e("div",me,[e("button",{onClick:k,disabled:B.value,class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[e("span",null,a(B.value?"Сохранение...":"Сохранить настройки"),1)],8,ge)]),e("div",fe,[e("div",null,[s[24]||(s[24]=e("h3",{class:"text-base font-medium mb-2"},"Разовая рассылка",-1)),s[25]||(s[25]=e("p",{class:"text-sm text-muted-foreground mb-4"}," Отправить сообщение всем пользователям с telegram_id прямо сейчас. Сообщение будет отправлено независимо от настроек периодической рассылки. ",-1)),M.value?(l(),o("div",pe,[s[19]||(s[19]=e("div",{class:"text-sm font-medium mb-1"},"Последняя разовая рассылка:",-1)),e("div",xe,a(new Date(M.value).toLocaleString("ru-RU")),1)])):u("",!0),e("div",_e,[s[22]||(s[22]=e("label",{class:"text-sm font-medium mb-2 block"},"Текст разовой рассылки",-1)),m(e("textarea",{"onUpdate:modelValue":s[4]||(s[4]=r=>f.value=r),rows:"4",placeholder:"Введите текст сообщения для разовой рассылки...",class:"w-full px-4 py-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent resize-none"},null,512),[[h,f.value]]),e("p",ye,[s[20]||(s[20]=T(" Доступные переменные: ",-1)),e("code",we,a(t.username),1),s[21]||(s[21]=T(", ",-1)),e("code",ke,a(t.tickets_count),1)])]),e("button",{onClick:H,disabled:!f.value||D.value,class:"h-11 px-6 bg-orange-500/10 backdrop-blur-xl text-orange-600 border border-orange-500/40 hover:bg-orange-500/20 rounded-2xl shadow-lg shadow-orange-500/10 inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[e("span",null,a(D.value?"Отправка...":"Отправить разовую рассылку"),1)],8,he),n.value?(l(),o("div",{key:1,class:C(["mt-4 p-4 rounded-lg",n.value.success?"bg-green-500/10 border border-green-500/20":"bg-destructive/10 border border-destructive/20"])},[e("div",{class:C([n.value.success?"text-green-600":"text-destructive","font-medium mb-2"])},a(n.value.success?"✓ Разовая рассылка завершена":"✗ Ошибка при рассылке"),3),n.value.stats?(l(),o("div",Te,[e("div",null,"Всего пользователей: "+a(n.value.stats.total),1),e("div",Ce,"Успешно отправлено: "+a(n.value.stats.sent),1),n.value.stats.failed>0?(l(),o("div",je,"Ошибок: "+a(n.value.stats.failed),1)):u("",!0),n.value.stats.skipped>0?(l(),o("div",Ue,"Пропущено: "+a(n.value.stats.skipped),1)):u("",!0)])):u("",!0),n.value.errors&&n.value.errors.length>0?(l(),o("div",Be,[s[23]||(s[23]=e("div",{class:"font-medium mb-1"},"Ошибки:",-1)),e("div",Me,[(l(!0),o(N,null,R(n.value.errors,(r,E)=>(l(),o("div",{key:E},a(r),1))),128))])])):u("",!0)],2)):u("",!0)])]),e("div",Ve,[e("div",null,[s[31]||(s[31]=e("h3",{class:"text-base font-medium mb-2"},"Тестовая отправка",-1)),s[32]||(s[32]=e("p",{class:"text-sm text-muted-foreground mb-4"}," Выберите пользователя для тестовой отправки сообщения и проверки работоспособности рассылки ",-1)),e("div",De,[s[26]||(s[26]=e("label",{class:"text-sm font-medium mb-2 block"},"Поиск пользователя",-1)),m(e("input",{"onUpdate:modelValue":s[5]||(s[5]=r=>b.value=r),onInput:L,type:"text",placeholder:"Поиск по ID, username или имени...",class:"w-full h-10 px-4 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent"},null,544),[[h,b.value]])]),w.value.length>0?(l(),o("div",Ie,[(l(!0),o(N,null,R(w.value,r=>(l(),o("div",{key:r.id,onClick:E=>q(r),class:C(["px-4 py-3 border-b border-border last:border-b-0 cursor-pointer hover:bg-muted/10 transition-colors",v.value?.id===r.id?"bg-accent/10":""])},[e("div",ze,[e("div",null,[e("div",Ee,a(r.name||"Без имени"),1),e("div",Ne," ID: "+a(r.id)+" | Telegram ID: "+a(r.telegram_id)+" | @"+a(r.username||"нет username"),1)]),v.value?.id===r.id?(l(),o("div",Re,"✓")):u("",!0)])],10,Se))),128))])):b.value&&!I.value?(l(),o("div",Fe," Пользователи не найдены ")):b.value?u("",!0):(l(),o("div",Le," Введите поисковый запрос для поиска пользователей ")),v.value?(l(),o("div",qe,[s[27]||(s[27]=e("div",{class:"text-sm font-medium mb-1"},"Выбранный пользователь:",-1)),e("div",Ae,a(v.value.name||"Без имени")+" (ID: "+a(v.value.id)+", Telegram: "+a(v.value.telegram_id)+") ",1)])):u("",!0),e("div",He,[s[28]||(s[28]=e("label",{class:"text-sm font-medium mb-2 block"},"Тестовое сообщение (опционально)",-1)),m(e("textarea",{"onUpdate:modelValue":s[6]||(s[6]=r=>S.value=r),rows:"3",placeholder:"Оставьте пустым, чтобы использовать текст из настроек",class:"w-full px-4 py-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent resize-none"},null,512),[[h,S.value]]),s[29]||(s[29]=e("p",{class:"text-xs text-muted-foreground mt-1"}," Если оставить пустым, будет использован текст из настроек рассылки ",-1))]),e("button",{onClick:A,disabled:!v.value||V.value,class:"h-11 px-6 bg-blue-500/10 backdrop-blur-xl text-blue-600 border border-blue-500/40 hover:bg-blue-500/20 rounded-2xl shadow-lg shadow-blue-500/10 inline-flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},[e("span",null,a(V.value?"Отправка...":"Отправить тестовое сообщение"),1)],8,Oe),i.value?(l(),o("div",{key:4,class:C(["mt-4 p-4 rounded-lg",i.value.success?"bg-green-500/10 border border-green-500/20":"bg-destructive/10 border border-destructive/20"])},[e("div",{class:C([i.value.success?"text-green-600":"text-destructive","font-medium mb-1"])},a(i.value.success?"✓ Сообщение отправлено успешно":"✗ Ошибка отправки"),3),i.value.message?(l(),o("div",$e,a(i.value.message),1)):u("",!0),i.value.sent_message?(l(),o("div",Ge,[s[30]||(s[30]=e("div",{class:"font-medium"},"Отправленное сообщение:",-1)),e("div",Je,a(i.value.sent_message),1)])):u("",!0)],2)):u("",!0)])])]))]))}},We=$(Ke,[["__scopeId","data-v-e44a87f4"]]);export{We as default};
