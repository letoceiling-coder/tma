import{_ as z,c as r,t as i,p as C,o,r as g,m as W,n as X,a as t,b,f as L,F as S,q as T,w as F,d as j,v as D,j as P,h as V,L as Y,s as Z,A as $,k as ee}from"./admin-DW4VoFCZ.js";import{S as w}from"./sweetalert2.esm.all-C0u8rGqG.js";const te={name:"StatusBadge",props:{status:{type:String,required:!0,validator:d=>["open","in_progress","closed"].includes(d)}},methods:{getStatusClass(d){const s={open:"bg-green-500/20 text-green-600 border border-green-500/30",in_progress:"bg-blue-500/20 text-blue-600 border border-blue-500/30",closed:"bg-gray-500/20 text-gray-600 border border-gray-500/30"};return s[d]||s.open},getStatusLabel(d){return{open:"–û—Ç–∫—Ä—ã—Ç",in_progress:"–í —Ä–∞–±–æ—Ç–µ",closed:"–ó–∞–∫—Ä—ã—Ç"}[d]||d}}};function se(d,s,m,e,x,f){return o(),r("span",{class:C(["px-2 py-1 text-xs rounded font-medium",f.getStatusClass(m.status)])},i(f.getStatusLabel(m.status)),3)}const q=z(te,[["render",se]]),ae={name:"TicketChat",components:{StatusBadge:q},props:{ticket:{type:Object,required:!0}},emits:["close","refresh"],setup(d,{emit:s}){const m=g(""),e=g([]),x=g(!1),f=g(null),y=W(()=>["open","in_progress"].includes(d.ticket.status)),n=()=>({Authorization:`Bearer ${localStorage.getItem("token")}`,Accept:"application/json"}),a=()=>{Y(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})},p=c=>{const h=Array.from(c.target.files);e.value=h},A=c=>{e.value.splice(c,1)},M=async()=>{if(!(!m.value.trim()&&e.value.length===0)){x.value=!0;try{const c=new FormData;c.append("ticket_id",d.ticket.id),c.append("message",m.value),e.value.forEach(_=>{c.append("attachments[]",_)});const h=await P.post("/api/v1/support/message",c,{headers:{...n(),"Content-Type":"multipart/form-data"}});if(h.data.success){m.value="",e.value=[],s("refresh");const _=await P.get(`/api/v1/support/tickets/${d.ticket.id}`,{headers:n()});_.data.success&&(Object.assign(d.ticket,_.data.data),a())}else w.fire("–û—à–∏–±–∫–∞",h.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}catch(c){w.fire("–û—à–∏–±–∫–∞",c.response?.data?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ","error")}finally{x.value=!1}}},k=c=>c?new Date(c).toLocaleString("ru-RU"):"";return X(()=>d.ticket.messages,()=>{a()},{deep:!0}),{newMessage:m,attachments:e,sending:x,messagesContainer:f,isChatEnabled:y,handleFileSelect:p,removeAttachment:A,sendMessage:M,formatDate:k}}},oe={class:"bg-card rounded-lg border border-border w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col"},re={class:"p-4 border-b border-border flex items-center justify-between"},ne={class:"text-xl font-semibold"},le={class:"flex items-center gap-2 mt-1"},de={class:"text-xs text-muted-foreground"},ie={class:"text-sm whitespace-pre-wrap"},ce={key:0,class:"mt-2 space-y-2"},ue=["href"],ge={class:"text-xs mt-2 opacity-70"},me={key:0,class:"p-4 bg-yellow-500/10 border-t border-yellow-500/20 text-center text-sm text-yellow-600"},be={key:1,class:"p-4 border-t border-border"},fe={key:0,class:"mt-2 space-y-1"},pe=["onClick"],ve={class:"flex gap-3"},he=["disabled"];function xe(d,s,m,e,x,f){const y=V("StatusBadge");return o(),r("div",{class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:s[4]||(s[4]=F(n=>d.$emit("close"),["self"]))},[t("div",oe,[t("div",re,[t("div",null,[t("h2",ne,i(m.ticket.theme),1),t("div",le,[L(y,{status:m.ticket.status},null,8,["status"]),t("span",de," –°–æ–∑–¥–∞–Ω: "+i(e.formatDate(m.ticket.created_at)),1)])]),t("button",{onClick:s[0]||(s[0]=n=>d.$emit("close")),class:"p-2 hover:bg-accent/10 rounded transition-colors"}," ‚úï ")]),t("div",{ref:"messagesContainer",class:C(["flex-1 overflow-y-auto p-4 space-y-4",{"opacity-50 pointer-events-none":!e.isChatEnabled}])},[(o(!0),r(S,null,T(m.ticket.messages,n=>(o(),r("div",{key:n.id,class:C(["flex",n.sender==="local"?"justify-end":"justify-start"])},[t("div",{class:C(["max-w-[70%] rounded-lg p-3",n.sender==="local"?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground"])},[t("p",ie,i(n.message),1),n.attachments&&n.attachments.length>0?(o(),r("div",ce,[(o(!0),r(S,null,T(n.attachments,(a,p)=>(o(),r("div",{key:p,class:"mt-2"},[a.url?(o(),r("a",{key:0,href:a.url,target:"_blank",class:"text-xs underline flex items-center gap-1"}," üìé "+i(a.name),9,ue)):b("",!0)]))),128))])):b("",!0),t("p",ge,i(e.formatDate(n.created_at)),1)],2)],2))),128))],2),e.isChatEnabled?b("",!0):(o(),r("div",me," –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ ")),e.isChatEnabled?(o(),r("div",be,[t("form",{onSubmit:s[3]||(s[3]=F((...n)=>e.sendMessage&&e.sendMessage(...n),["prevent"])),class:"space-y-3"},[t("div",null,[j(t("textarea",{"onUpdate:modelValue":s[1]||(s[1]=n=>e.newMessage=n),rows:"3",placeholder:"–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",class:"w-full px-3 py-2 border border-border rounded bg-background resize-none",required:""},null,512),[[D,e.newMessage]])]),t("div",null,[t("input",{type:"file",onChange:s[2]||(s[2]=(...n)=>e.handleFileSelect&&e.handleFileSelect(...n)),multiple:"",accept:"image/*,.pdf,.doc,.docx,.txt",class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},null,32),e.attachments.length>0?(o(),r("div",fe,[(o(!0),r(S,null,T(e.attachments,(n,a)=>(o(),r("div",{key:a,class:"text-sm text-muted-foreground flex items-center justify-between"},[t("span",null,i(n.name),1),t("button",{type:"button",onClick:p=>e.removeAttachment(a),class:"text-destructive hover:text-destructive/80"}," ‚úï ",8,pe)]))),128))])):b("",!0)]),t("div",ve,[t("button",{type:"submit",disabled:e.sending||!e.newMessage.trim(),class:"px-4 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/90 disabled:opacity-50 transition-colors"},i(e.sending?"–û—Ç–ø—Ä–∞–≤–∫–∞...":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å"),9,he)])],32)])):b("",!0)])])}const ke=z(ae,[["render",xe]]),ye={name:"Support",components:{StatusBadge:q,TicketChat:ke},setup(){const d=g(!1),s=g(null),m=g([]),e=g(null),x=g(null),f=g(null),y=g(!1),n=g(!1),a=g({search:"",status:""}),p=g(1),A=g(20),M=g(null),k=g({theme:"",message:"",attachments:[]}),c=()=>({Authorization:`Bearer ${localStorage.getItem("token")}`,Accept:"application/json"}),h=async(l=1)=>{d.value=!0,s.value=null;try{const u=new URLSearchParams;u.append("page",l),u.append("per_page",A.value),a.value.status&&u.append("status",a.value.status);const v=await P.get(`/api/v1/support/tickets?${u.toString()}`,{headers:c()});v.data.success&&(m.value=v.data.data.data||[],e.value={current_page:v.data.data.current_page,last_page:v.data.data.last_page,from:v.data.data.from,to:v.data.data.to,total:v.data.data.total})}catch(u){s.value=u.response?.data?.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–∫–µ—Ç–æ–≤",console.error("Error fetching tickets:",u)}finally{d.value=!1}},_=async l=>{x.value=l;try{const u=await P.get(`/api/v1/support/tickets/${l}`,{headers:c()});u.data.success&&(f.value=u.data.data)}catch{w.fire("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–∫–µ—Ç","error")}},R=()=>{f.value=null,x.value=null},I=()=>{p.value=1,h(1)},H=()=>{M.value&&clearTimeout(M.value),M.value=setTimeout(()=>{p.value=1,h(1)},500)},N=l=>{p.value=l,h(l)},O=(l,u)=>{const v=[];let B=Math.max(1,l-Math.floor(2.5)),E=Math.min(u,B+5-1);E-B<4&&(B=Math.max(1,E-5+1));for(let U=B;U<=E;U++)v.push(U);return v},G=l=>l?new Date(l).toLocaleString("ru-RU"):"",J=l=>{const u=Array.from(l.target.files);k.value.attachments=u},K=l=>{k.value.attachments.splice(l,1)},Q=async()=>{n.value=!0;try{const l=new FormData;l.append("theme",k.value.theme),l.append("message",k.value.message),k.value.attachments.forEach(v=>{l.append("attachments[]",v)});const u=await P.post("/api/v1/support/ticket",l,{headers:{...c(),"Content-Type":"multipart/form-data"}});u.data.success?(w.fire("–£—Å–ø–µ—Ö","–¢–∏–∫–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω","success"),y.value=!1,k.value={theme:"",message:"",attachments:[]},h()):w.fire("–û—à–∏–±–∫–∞",u.data.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç","error")}catch(l){w.fire("–û—à–∏–±–∫–∞",l.response?.data?.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç","error")}finally{n.value=!1}};return ee(()=>{h()}),{loading:d,error:s,tickets:m,pagination:e,selectedTicketId:x,selectedTicket:f,showCreateModal:y,creating:n,filters:a,newTicket:k,fetchTickets:h,selectTicket:_,closeChat:R,handleFilterChange:I,handleSearch:H,handlePageChange:N,getPageNumbers:O,formatDate:G,handleFileSelect:J,removeAttachment:K,createTicket:Q}}},_e={class:"support-page space-y-6"},we={class:"flex items-center justify-between"},Ce={class:"bg-card rounded-lg border border-border p-4"},Se={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Te={class:"md:col-span-2"},Me={class:"relative"},je={key:0,class:"flex items-center justify-center py-12"},Pe={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},Ae={class:"text-destructive"},Be={key:2,class:"space-y-3"},De=["onClick"],Fe={class:"flex items-start justify-between gap-4"},Ee={class:"flex-1 min-w-0"},Ue={class:"flex items-center gap-2 mb-2"},Ve={class:"font-semibold text-foreground"},ze={class:"text-sm text-muted-foreground mb-2"},Le={class:"flex items-center gap-4 text-xs text-muted-foreground"},qe={key:0},Re={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},Ie={key:4,class:"flex flex-col sm:flex-row items-center justify-between pt-6 border-t border-border gap-4"},He={class:"text-sm text-muted-foreground"},Ne={class:"flex gap-2 items-center"},Oe=["disabled"],Ge={class:"flex gap-1"},Je=["onClick"],Ke=["disabled"],Qe={class:"bg-card rounded-lg border border-border p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"},We={class:"space-y-4"},Xe={key:0,class:"mt-2 space-y-1"},Ye=["onClick"],Ze={class:"flex gap-3 mt-6"},$e=["disabled"];function et(d,s,m,e,x,f){const y=V("StatusBadge"),n=V("TicketChat");return o(),r("div",_e,[t("div",we,[s[13]||(s[13]=t("div",null,[t("h1",{class:"text-3xl font-semibold text-foreground"},"–ü–æ–¥–¥–µ—Ä–∂–∫–∞"),t("p",{class:"text-muted-foreground mt-1"},"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏")],-1)),t("button",{onClick:s[0]||(s[0]=a=>e.showCreateModal=!0),class:"px-4 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/90 transition-colors"}," + –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç ")]),t("div",Ce,[t("div",Se,[t("div",null,[j(t("select",{"onUpdate:modelValue":s[1]||(s[1]=a=>e.filters.status=a),onChange:s[2]||(s[2]=(...a)=>e.handleFilterChange&&e.handleFilterChange(...a)),class:"w-full h-10 px-3 border border-border rounded bg-background text-sm"},[...s[14]||(s[14]=[t("option",{value:""},"–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã",-1),t("option",{value:"open"},"–û—Ç–∫—Ä—ã—Ç",-1),t("option",{value:"in_progress"},"–í —Ä–∞–±–æ—Ç–µ",-1),t("option",{value:"closed"},"–ó–∞–∫—Ä—ã—Ç",-1)])],544),[[$,e.filters.status]])]),t("div",Te,[t("div",Me,[s[15]||(s[15]=t("span",{class:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"},"üîç",-1)),j(t("input",{type:"text","onUpdate:modelValue":s[3]||(s[3]=a=>e.filters.search=a),onInput:s[4]||(s[4]=(...a)=>e.handleSearch&&e.handleSearch(...a)),placeholder:"–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ...",class:"w-full h-10 pl-9 pr-3 border border-border rounded bg-background text-sm"},null,544),[[D,e.filters.search]])])])])]),e.loading?(o(),r("div",je,[...s[16]||(s[16]=[t("p",{class:"text-muted-foreground"},"–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤...",-1)])])):b("",!0),e.error?(o(),r("div",Pe,[t("p",Ae,i(e.error),1)])):b("",!0),!e.loading&&e.tickets.length>0?(o(),r("div",Be,[(o(!0),r(S,null,T(e.tickets,a=>(o(),r("div",{key:a.id,onClick:p=>e.selectTicket(a.id),class:C(["bg-card rounded-lg border p-4 cursor-pointer transition-colors hover:border-accent",e.selectedTicketId===a.id?"border-accent bg-accent/5":"border-border"])},[t("div",Fe,[t("div",Ee,[t("div",Ue,[t("h3",Ve,i(a.theme),1),L(y,{status:a.status},null,8,["status"])]),t("p",ze,i(a.messages?.[0]?.message?.substring(0,100)||"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π")+"... ",1),t("div",Le,[t("span",null,"–°–æ–∑–¥–∞–Ω: "+i(e.formatDate(a.created_at)),1),a.messages?.length?(o(),r("span",qe," –°–æ–æ–±—â–µ–Ω–∏–π: "+i(a.messages.length),1)):b("",!0)])])])],10,De))),128))])):b("",!0),!e.loading&&e.tickets.length===0?(o(),r("div",Re,[...s[17]||(s[17]=[t("p",{class:"text-muted-foreground"},"–¢–∏–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",-1)])])):b("",!0),e.pagination&&e.pagination.last_page>1?(o(),r("div",Ie,[t("div",He,[t("span",null," –ü–æ–∫–∞–∑–∞–Ω–æ "+i(e.pagination.from)+"-"+i(e.pagination.to)+" –∏–∑ "+i(e.pagination.total),1)]),t("div",Ne,[t("button",{onClick:s[5]||(s[5]=a=>e.handlePageChange(e.pagination.current_page-1)),disabled:e.pagination.current_page===1,class:"px-3 py-2 rounded-md border border-border bg-background hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors"}," ‚Üê –ù–∞–∑–∞–¥ ",8,Oe),t("div",Ge,[(o(!0),r(S,null,T(e.getPageNumbers(e.pagination.current_page,e.pagination.last_page),a=>(o(),r("button",{key:a,onClick:p=>e.handlePageChange(a),class:C(["px-3 py-2 rounded-md border text-sm transition-colors min-w-[40px]",a===e.pagination.current_page?"bg-accent text-accent-foreground border-accent font-semibold":"border-border bg-background hover:bg-accent/10"])},i(a),11,Je))),128))]),t("button",{onClick:s[6]||(s[6]=a=>e.handlePageChange(e.pagination.current_page+1)),disabled:e.pagination.current_page===e.pagination.last_page,class:"px-3 py-2 rounded-md border border-border bg-background hover:bg-accent/10 disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors"}," –í–ø–µ—Ä–µ–¥ ‚Üí ",8,Ke)])])):b("",!0),e.selectedTicket?(o(),Z(n,{key:5,ticket:e.selectedTicket,onClose:e.closeChat,onRefresh:e.fetchTickets},null,8,["ticket","onClose","onRefresh"])):b("",!0),e.showCreateModal?(o(),r("div",{key:6,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:s[12]||(s[12]=F(a=>e.showCreateModal=!1,["self"]))},[t("div",Qe,[s[21]||(s[21]=t("h2",{class:"text-2xl font-semibold mb-4"},"–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç",-1)),t("form",{onSubmit:s[11]||(s[11]=F((...a)=>e.createTicket&&e.createTicket(...a),["prevent"]))},[t("div",We,[t("div",null,[s[18]||(s[18]=t("label",{class:"block text-sm font-medium mb-2"},"–¢–µ–º–∞",-1)),j(t("input",{"onUpdate:modelValue":s[7]||(s[7]=a=>e.newTicket.theme=a),type:"text",required:"",class:"w-full h-10 px-3 border border-border rounded bg-background",placeholder:"–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —Ç–∏–∫–µ—Ç–∞"},null,512),[[D,e.newTicket.theme]])]),t("div",null,[s[19]||(s[19]=t("label",{class:"block text-sm font-medium mb-2"},"–°–æ–æ–±—â–µ–Ω–∏–µ",-1)),j(t("textarea",{"onUpdate:modelValue":s[8]||(s[8]=a=>e.newTicket.message=a),required:"",rows:"5",class:"w-full px-3 py-2 border border-border rounded bg-background resize-none",placeholder:"–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"},null,512),[[D,e.newTicket.message]])]),t("div",null,[s[20]||(s[20]=t("label",{class:"block text-sm font-medium mb-2"},"–í–ª–æ–∂–µ–Ω–∏—è",-1)),t("input",{type:"file",onChange:s[9]||(s[9]=(...a)=>e.handleFileSelect&&e.handleFileSelect(...a)),multiple:"",accept:"image/*,.pdf,.doc,.docx,.txt",class:"w-full h-10 px-3 border border-border rounded bg-background"},null,32),e.newTicket.attachments.length>0?(o(),r("div",Xe,[(o(!0),r(S,null,T(e.newTicket.attachments,(a,p)=>(o(),r("div",{key:p,class:"text-sm text-muted-foreground flex items-center justify-between"},[t("span",null,i(a.name),1),t("button",{type:"button",onClick:A=>e.removeAttachment(p),class:"text-destructive hover:text-destructive/80"}," ‚úï ",8,Ye)]))),128))])):b("",!0)])]),t("div",Ze,[t("button",{type:"submit",disabled:e.creating,class:"px-4 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/90 disabled:opacity-50 transition-colors"},i(e.creating?"–°–æ–∑–¥–∞–Ω–∏–µ...":"–°–æ–∑–¥–∞—Ç—å"),9,$e),t("button",{type:"button",onClick:s[10]||(s[10]=a=>e.showCreateModal=!1),class:"px-4 py-2 border border-border rounded-lg hover:bg-accent/10 transition-colors"}," –û—Ç–º–µ–Ω–∞ ")])],32)])])):b("",!0)])}const ot=z(ye,[["render",et]]);export{ot as default};
